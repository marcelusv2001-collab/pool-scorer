<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Ball Offline Scorer</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --apa-blue: #0056b3; --border: #333; }
        body { font-family: "Courier New", Courier, monospace; background: #999; margin: 0; padding: 10px; }
        .paper { background: #fff; border: 1px solid var(--border); max-width: 600px; margin: auto; padding: 20px; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2px solid var(--border); }
        .header-table td { border: 1px solid var(--border); padding: 5px; font-size: 0.8rem; }
        
        .match-section { border: 2px solid var(--border); margin-bottom: 10px; }
        .player-row { display: flex; background: #eee; border-bottom: 2px solid var(--border); }
        .player-info { flex: 2; padding: 10px; border-right: 2px solid var(--border); }
        .score-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
        
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; padding: 10px; background: #fff; }
        .stat-btn-group { display: flex; align-items: center; justify-content: space-between; border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
        
        .btn { width: 35px; height: 35px; border: 1px solid var(--border); background: #f0f0f0; font-weight: bold; cursor: pointer; }
        .btn:active { background: #ccc; }
        .val { font-size: 1.2rem; font-weight: bold; width: 30px; text-align: center; }

        .action-menu { position: sticky; bottom: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #999; }
        button.main { padding: 15px; border: 2px solid #000; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="capture-area" class="paper">
    <table class="header-table">
        <tr>
            <td colspan="2"><strong>8-BALL SCORESHEET</strong></td>
            <td>WEEK: <input type="text" style="width:40px; border:none; border-bottom:1px solid #000;"></td>
        </tr>
    </table>

    <div id="match-list"></div>

    <div style="margin-top:10px; font-weight:bold; border-top:2px solid #000; padding-top:10px;">
        TOTAL TEAM POINTS: <span id="grand-total">0</span>
    </div>
</div>

<div class="action-menu">
    <button class="main" style="grid-column: span 2; background: #27ae60; color: white;" onclick="addNewMatch()">+ Add New Match</button>
    <button class="main" style="background: #2980b9; color: white;" onclick="exportJPG()">Export JPG</button>
    <button class="main" style="background: #f1c40f;" onclick="copyText()">Copy Text</button>
    <button class="main" style="grid-column: span 2; background: #e74c3c; color: white;" onclick="resetSheet()">Reset Entire Night</button>
</div>

<script>
    let matches = JSON.parse(localStorage.getItem('offlineMatches')) || [];

    function updateStorage() {
        localStorage.setItem('offlineMatches', JSON.stringify(matches));
        render();
    }

    function addNewMatch() {
        if(matches.length >= 5) return alert("Limit 5 matches.");
        matches.push({ name: '', sl: 3, games: 0, innings: 0, def: 0 });
        updateStorage();
    }

    function editMatch(index, field, value) {
        matches[index][field] = value;
        updateStorage();
    }

    function step(index, field, delta) {
        matches[index][field] = Math.max(0, matches[index][field] + delta);
        updateStorage();
    }

    function render() {
        const list = document.getElementById('match-list');
        list.innerHTML = '';
        let totalGames = 0;

        matches.forEach((m, i) => {
            totalGames += parseInt(m.games);
            list.innerHTML += `
                <div class="match-section">
                    <div class="player-row">
                        <div class="player-info">
                            <input type="text" placeholder="PLAYER NAME" value="${m.name}" onchange="editMatch(${i}, 'name', this.value)" style="width:100%; margin-bottom:5px; border:none; border-bottom:1px solid #000;">
                            <div style="display:flex; gap:10px; font-size:0.7rem;">
                                SL: <input type="number" value="${m.sl}" onchange="editMatch(${i}, 'sl', this.value)" style="width:30px;">
                            </div>
                        </div>
                        <div class="score-box">
                            <div style="font-size:0.6rem;">GAMES WON</div>
                            <div class="stat-btn-group" style="border:none;">
                                <button class="btn" onclick="step(${i}, 'games', -1)">-</button>
                                <span class="val">${m.games}</span>
                                <button class="btn" onclick="step(${i}, 'games', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-container">
                        <div class="stat-btn-group">
                            <span style="font-size:0.7rem;">INNINGS</span>
                            <button class="btn" onclick="step(${i}, 'innings', -1)">-</button>
                            <span class="val">${m.innings}</span>
                            <button class="btn" onclick="step(${i}, 'innings', 1)">+</button>
                        </div>
                        <div class="stat-btn-group">
                            <span style="font-size:0.7rem;">DEFENSIVE</span>
                            <button class="btn" onclick="step(${i}, 'def', -1)">-</button>
                            <span class="val">${m.def}</span>
                            <button class="btn" onclick="step(${i}, 'def', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;
        });
        document.getElementById('grand-total').innerText = totalGames;
    }

    function exportJPG() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const link = document.createElement('a');
            link.download = '8ball_scoresheet.jpg';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function copyText() {
        let txt = "OFFLINE SCORESHEET\\n";
        matches.forEach((m, i) => txt += `M${i+1}: ${m.name}(SL${m.sl}) G:${m.games} I:${m.innings} D:${m.def}\\n`);
        navigator.clipboard.writeText(txt);
        alert("Scores copied!");
    }

    function resetSheet() {
        if(confirm("Start new night?")) {
            matches = [];
            updateStorage();
        }
    }

    render();
</script>
</body>
</html>