<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Ball League Master</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --border: #000; --header-bg: #e9e9e9; --win-color: #d4edda; }
        body { font-family: 'Courier New', Courier, monospace; background: #666; margin: 0; padding: 10px; font-size: 14px; }
        .sheet { background: #fff; border: 2px solid var(--border); max-width: 700px; margin: auto; padding: 15px; }
        .match-card { border: 2px solid var(--border); margin-bottom: 25px; position: relative; }
        .match-header { background: #000; color: #fff; padding: 8px; font-weight: bold; display: flex; justify-content: space-between; }
        
        .grid-main { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border); }
        .side { padding: 10px; border-right: 1px solid var(--border); position: relative; }
        .side:last-child { border-right: none; }
        
        .lag-row { background: #f9f9f9; padding: 5px; border-bottom: 1px solid #000; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .side-label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        
        select, input[type="text"] { width: 100%; margin-bottom: 5px; border: 1px solid #ccc; padding: 4px; box-sizing: border-box; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; text-align: center; }
        .stat-box { border: 1px solid #eee; padding: 5px; }
        .stat-label { font-size: 0.6rem; font-weight: bold; display: block; margin-bottom: 3px; }
        
        .stepper { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn { width: 28px; height: 28px; border: 1px solid #000; background: #eee; cursor: pointer; font-weight: bold; }
        .val { font-size: 1rem; font-weight: bold; min-width: 20px; }

        .special-stats { font-size: 0.65rem; color: #555; margin-top: 5px; text-align: left; background: #f0f0f0; padding: 3px; border-radius: 3px; }

        /* Modal / Popup Styles */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 300px; text-align: center; }
        .modal button { display: block; width: 100%; margin: 10px 0; padding: 10px; font-weight: bold; cursor: pointer; border: 1px solid #000; }

        .footer { border-top: 2px solid #000; padding: 15px; background: var(--header-bg); font-weight: bold; display: flex; justify-content: space-between; }
        .actions { position: sticky; bottom: 0; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #666; }
        .action-btn { padding: 12px; border: 2px solid #000; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="modal-overlay">
    <div class="modal">
        <h3>How was the game won?</h3>
        <button onclick="recordWinType('8BB')">8BB (8-Ball Break)</button>
        <button onclick="recordWinType('B&R')">B&R (Break and Run)</button>
        <button onclick="recordWinType('S8')">S8 (Snap 8 / 9-on-Snap)</button>
        <button onclick="recordWinType('E8')">E8 (Early 8-Ball)</button>
        <button onclick="recordWinType('WP')">WP (Wrong Pocket)</button>
        <button onclick="recordWinType('Normal')" style="background:#eee;">Normal Win</button>
    </div>
</div>

<div id="capture-area" class="sheet">
    <div style="text-align:center; border-bottom:2px solid #000; margin-bottom:10px;">
        <h2 style="margin:5px;">OFFICIAL NIGHTLY BACKUP</h2>
    </div>

    <div id="match-container"></div>

    <div class="footer">
        <div>TEAM HOME PTS: <input type="number" id="team-home-pts" style="width:40px;" oninput="saveGlobal()"></div>
        <div>TEAM AWAY PTS: <input type="number" id="team-away-pts" style="width:40px;" oninput="saveGlobal()"></div>
    </div>
</div>

<div class="actions">
    <button class="action-btn" style="grid-column: span 2; background: #2ed573;" onclick="addMatch()">+ Add New Match</button>
    <button class="action-btn" style="background: #1e90ff; color: #fff;" onclick="exportJPG()">Export JPG</button>
    <button class="action-btn" style="background: #ffa502;" onclick="exportText()">Copy Text</button>
    <button class="action-btn" style="grid-column: span 2; background: #ff4757; color: white;" onclick="clearAll()">Reset Session</button>
</div>

<script>
    let matches = JSON.parse(localStorage.getItem('billiardAdvSession')) || [];
    let activeWinContext = { idx: null, side: null };

    function refresh() {
        localStorage.setItem('billiardAdvSession', JSON.stringify(matches));
        const container = document.getElementById('match-container');
        container.innerHTML = '';

        matches.forEach((m, i) => {
            container.innerHTML += `
                <div class="match-card">
                    <div class="match-header"><span>MATCH ${i+1}</span> <span>INN: ${m.innings}</span></div>
                    <div class="lag-row">
                        LAG WINNER: 
                        <label><input type="radio" name="lag${i}" ${m.lagWinner==='home'?'checked':''} onclick="setLag(${i}, 'home')"> HOME</label>
                        <label><input type="radio" name="lag${i}" ${m.lagWinner==='away'?'checked':''} onclick="setLag(${i}, 'away')"> AWAY</label>
                    </div>
                    <div class="grid-main">
                        ${renderSide(i, 'home', m.home)}
                        ${renderSide(i, 'away', m.away)}
                    </div>
                    <div style="padding:5px; border-top:1px solid #000; text-align:center;">
                        INN: <button class="btn" onclick="stepMatch(${i}, 'innings', -1)">-</button>
                        <span class="val">${m.innings}</span>
                        <button class="btn" onclick="stepMatch(${i}, 'innings', 1)">+</button>
                    </div>
                </div>
            `;
        });
        document.getElementById('team-home-pts').value = localStorage.getItem('teamHome') || 0;
        document.getElementById('team-away-pts').value = localStorage.getItem('teamAway') || 0;
    }

    function renderSide(idx, side, data) {
        return `
            <div class="side">
                <span class="side-label">${side}</span>
                <input type="text" placeholder="Name" value="${data.name}" oninput="update(${idx}, '${side}', 'name', this.value)">
                <select onchange="update(${idx}, '${side}', 'sl', this.value)">
                    ${[2,3,4,5,6,7].map(num => `<option value="${num}" ${data.sl==num?'selected':''}>SL ${num}</option>`).join('')}
                </select>
                
                <div class="stat-grid">
                    <div class="stat-box">
                        <span class="stat-label">GAMES WON</span>
                        <div class="stepper">
                            <button class="btn" onclick="step(${idx}, '${side}', 'games', -1)">-</button>
                            <span class="val">${data.games}</span>
                            <button class="btn" onclick="triggerWinPopup(${idx}, '${side}')">+</button>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">TIMEOUTS</span>
                        <div class="stepper">
                            <button class="btn" onclick="step(${idx}, '${side}', 'timeouts', -1)">-</button>
                            <span class="val">${data.timeouts}</span>
                            <button class="btn" onclick="step(${idx}, '${side}', 'timeouts', 1)">+</button>
                        </div>
                    </div>
                    <div class="stat-box" style="grid-column: span 2;">
                        <span class="stat-label">DEFENSIVE</span>
                        <div class="stepper">
                            <button class="btn" onclick="step(${idx}, '${side}', 'def', -1)">-</button>
                            <span class="val">${data.def}</span>
                            <button class="btn" onclick="step(${idx}, '${side}', 'def', 1)">+</button>
                        </div>
                    </div>
                </div>
                <div class="special-stats">
                    Wins: ${Object.entries(data.winTypes).filter(([k,v]) => v > 0).map(([k,v]) => `${k}x${v}`).join(', ') || 'Normal'}
                </div>
            </div>
        `;
    }

    function addMatch() {
        if (matches.length < 5) {
            matches.push({
                innings: 0, lagWinner: '',
                home: { name: '', sl: 3, games: 0, def: 0, timeouts: 0, winTypes: { '8BB':0, 'B&R':0, 'S8':0, 'E8':0, 'WP':0 } },
                away: { name: '', sl: 3, games: 0, def: 0, timeouts: 0, winTypes: { '8BB':0, 'B&R':0, 'S8':0, 'E8':0, 'WP':0 } }
            });
            refresh();
        }
    }

    function triggerWinPopup(idx, side) {
        activeWinContext = { idx, side };
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function recordWinType(type) {
        const { idx, side } = activeWinContext;
        matches[idx][side].games++;
        if (type !== 'Normal') {
            matches[idx][side].winTypes[type]++;
        }
        document.getElementById('modal-overlay').style.display = 'none';
        refresh();
    }

    function update(idx, side, field, val) { matches[idx][side][field] = val; localStorage.setItem('billiardAdvSession', JSON.stringify(matches)); }
    function setLag(idx, winner) { matches[idx].lagWinner = winner; refresh(); }
    function step(idx, side, field, d) { matches[idx][side][field] = Math.max(0, matches[idx][side][field] + d); refresh(); }
    function stepMatch(idx, field, d) { matches[idx][field] = Math.max(0, matches[idx][field] + d); refresh(); }
    
    function saveGlobal() {
        localStorage.setItem('teamHome', document.getElementById('team-home-pts').value);
        localStorage.setItem('teamAway', document.getElementById('team-away-pts').value);
    }

    function exportText() {
        let log = "SESSION SUMMARY\\n";
        matches.forEach((m, i) => log += `M${i+1}: Lag Won by ${m.lagWinner.toUpperCase()} | Innings: ${m.innings}\\n`);
        navigator.clipboard.writeText(log); alert("Copied!");
    }

    function exportJPG() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'league_night_full.jpg';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function clearAll() { if(confirm("Clear night?")) { matches = []; localStorage.removeItem('teamHome'); localStorage.removeItem('teamAway'); refresh(); } }
    refresh();
</script>
</body>
</html>