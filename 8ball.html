<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP TV - Pro Scorekeeper 2026</title>
    <style>
        :root { --slate: #0f172a; --surface: #1e293b; --felt: #10b981; --gold: #f59e0b; --danger: #ef4444; --text: #f8fafc; --border: #334155; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-user-select: none; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--slate); margin: 0; padding: 12px; color: var(--text); line-height: 1.5; }
        .app-container { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 20px; max-width: 500px; margin: auto; min-height: 85vh; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .match-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .match-badge { background: var(--slate); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; color: var(--gold); border: 1px solid var(--gold); font-weight: 800; }
        .lag-badge { background: var(--gold); color: var(--slate); padding: 6px 14px; border-radius: 12px; font-size: 0.7rem; font-weight: 900; cursor: pointer; }
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .player-card { background: var(--slate); border: 1px solid var(--border); padding: 12px; border-radius: 16px; position: relative; }
        .score-bubble { position: absolute; top: -10px; right: -10px; background: var(--felt); color: white; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; border: 2px solid var(--slate); box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .player-input { width: 100%; background: transparent; border: none; color: white; font-weight: 700; border-bottom: 1px solid var(--border); margin-bottom: 8px; outline: none; padding: 6px 0; font-size: 1rem; }
        .sl-select { width: 100%; background: var(--surface); color: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-weight: bold; }
        .scoring-arena { display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 20px; }
        .btn-pro { background: var(--slate); border: 1px solid var(--border); color: white; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; transition: transform 0.1s; }
        .btn-pro.win { background: var(--felt); width: 80px; height: 80px; font-weight: 900; font-size: 1.1rem; border: none; }
        .btn-inning { width: 68px; height: 68px; border-radius: 15px; border: 3px solid var(--gold); background: var(--slate); color: var(--gold); font-size: 1.8rem; font-weight: 900; cursor: pointer; }
        .btn-pro:active, .btn-inning:active { transform: scale(0.9); }
        .session-overview { margin-top: 24px; background: var(--slate); border-radius: 16px; padding: 15px; border: 1px solid var(--border); }
        .table-row { display: grid; grid-template-columns: 0.8fr 2.5fr 1fr 1fr; gap: 8px; font-size: 0.9rem; border-bottom: 1px solid var(--surface); padding: 10px 0; align-items: center; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        .modal-box { background: var(--surface); padding: 25px; border-radius: 25px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .win-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }
        .btn-win-opt { background: var(--slate); color: white; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-action { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 0.95rem; }
        #normal-actions { display: block; }
        #edit-actions { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="match-header">
            <div class="match-badge">MATCH <span id="match-num">1</span> OF 5</div>
            <div id="lag-display" class="lag-badge" onclick="toggleLag()">LAG: HOME</div>
            <div class="match-badge" id="race-display">RACE 0 - 0</div>
        </div>
        <div class="player-grid">
            <div class="player-card">
                <div class="score-bubble" id="h-games">0</div>
                <input type="text" id="h-name" class="player-input" value="Player A">
                <select id="h-sl" class="sl-select" onchange="updateRace()">
                    <option value="2">SL2</option><option value="3">SL3</option><option value="4" selected>SL4</option><option value="5">SL5</option><option value="6">SL6</option><option value="7">SL7</option>
                </select>
            </div>
            <div class="player-card">
                <div class="score-bubble" id="a-games">0</div>
                <input type="text" id="a-name" class="player-input" value="Player B">
                <select id="a-sl" class="sl-select" onchange="updateRace()">
                    <option value="2">SL2</option><option value="3">SL3</option><option value="4" selected>SL4</option><option value="5">SL5</option><option value="6">SL6</option><option value="7">SL7</option>
                </select>
            </div>
        </div>
        <div class="scoring-arena">
            <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                <button class="btn-pro" id="btn-hDef">Def <span id="hDef-val">0</span></button>
                <button class="btn-pro" id="btn-hTO">T.O. <span id="hTO-val">0</span></button>
                <button class="btn-pro win" onclick="openWin('h')">RACK</button>
            </div>
            <button class="btn-inning" id="innings-btn"><span id="innings-val">0</span></button>
            <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                <button class="btn-pro" id="btn-aDef">Def <span id="aDef-val">0</span></button>
                <button class="btn-pro" id="btn-aTO">T.O. <span id="aTO-val">0</span></button>
                <button class="btn-pro win" onclick="openWin('a')">RACK</button>
            </div>
        </div>
        <div class="session-overview">
            <div style="text-align:center; font-size:0.85rem; font-weight:800; color:var(--gold); margin-bottom:10px;">SESSION SUMMARY (MATCH PTS)</div>
            <div id="results-list"></div>
        </div>
        <!-- Normal Session Actions -->
        <div id="normal-actions">
            <button class="btn-action" onclick="exportSession()" style="background:var(--felt); color:var(--slate);">EXPORT SESSION</button>
            <button class="btn-action" onclick="clearSession()" style="background:var(--danger); color:white;">RESET ALL DATA</button>
        </div>
        <!-- Editing Mode Actions -->
        <div id="edit-actions">
            <button class="btn-action" onclick="saveEditedMatch()" style="background:var(--felt); color:var(--slate);">SAVE EDITS TO MATCH</button>
            <button class="btn-action" onclick="location.reload()" style="background:var(--danger); color:white;">CANCEL EDITING</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="winModal" class="modal"><div class="modal-box"><h3>Game Outcome</h3><div class="win-grid"><button class="btn-win-opt" onclick="confirmRack('Normal')">Normal</button><button class="btn-win-opt" onclick="confirmRack('8BB')">8BB</button><button class="btn-win-opt" onclick="confirmRack('B&R')">B&R</button><button class="btn-win-opt" onclick="confirmRack('S8')">S8</button><button class="btn-win-opt" onclick="confirmRack('E8')">E8</button><button class="btn-win-opt" onclick="confirmRack('WP')">WP</button></div><button class="btn-action" style="background:var(--danger); color:white;" onclick="closeM('winModal')">Cancel</button></div></div>
    <div id="detailsModal" class="modal"><div class="modal-box"><h3 id="det-title" style="color:var(--gold)">Match Details</h3><div id="det-content" style="text-align:left; margin-bottom: 15px;"></div><button class="btn-action" style="background:var(--felt); color:var(--slate);" onclick="initEdit()">Edit This Match</button><button class="btn-action" onclick="closeM('detailsModal')">Close</button></div></div>

<script>
    const CHART = { 
        2: {2:2, 3:2, 4:2, 5:2, 6:2, 7:2}, 
        3: {2:3, 3:2, 4:2, 5:2, 6:2, 7:2}, 
        4: {2:4, 3:3, 4:3, 5:3, 6:3, 7:2}, 
        5: {2:5, 3:4, 4:4, 5:4, 6:4, 7:3}, 
        6: {2:6, 3:5, 4:5, 5:5, 6:5, 7:4}, 
        7: {2:7, 3:6, 4:6, 5:6, 6:6, 7:5} 
    };
    let session = JSON.parse(localStorage.getItem('mvp_session')) || [];
    let cur = { hDef: 0, aDef: 0, hTO: 0, aTO: 0, innings: 0, winnerSide: '', hGames: 0, aGames: 0, rackHistory: [], lag: 'Home', editingIdx: -1 };
    let holdTimer;

    function toggleLag() { cur.lag = (cur.lag === 'Home' ? 'Away' : 'Home'); document.getElementById('lag-display').innerText = `LAG: ${cur.lag.toUpperCase()}`; }
    
    function updateRace() {
        const h = document.getElementById('h-sl').value, a = document.getElementById('a-sl').value;
        const rH = CHART[h][a], rA = CHART[a][h];
        document.getElementById('race-display').innerText = `RACE ${rH} - ${rA}`;
        if (cur.editingIdx === -1) checkMatchEnd(rH, rA);
    }

    document.querySelectorAll('.btn-pro, .btn-inning').forEach(btn => {
        const stat = btn.id.replace('btn-', '');
        btn.onmousedown = btn.ontouchstart = (e) => {
            e.preventDefault();
            holdTimer = setTimeout(() => {
                cur[stat] = 0; document.getElementById(stat + '-val').innerText = 0;
                btn.classList.add('reset-flash'); setTimeout(() => btn.classList.remove('reset-flash'), 400);
                holdTimer = null;
            }, 800);
        };
        btn.onmouseup = btn.ontouchend = () => {
            if (holdTimer) { clearTimeout(holdTimer); cur[stat]++; document.getElementById(stat + '-val').innerText = cur[stat]; holdTimer = null; }
            if (cur.editingIdx > -1) updateRace(); // Update race on every stat change while editing
        };
    });

    function checkMatchEnd(rH, rA) {
        if (cur.hGames >= rH || cur.aGames >= rA) {
            setTimeout(() => { if (confirm("Match Complete. Save results to session?")) saveMatch(rH, rA); }, 200);
        }
    }

    function saveEditedMatch() {
        const h = document.getElementById('h-sl').value, a = document.getElementById('a-sl').value;
        saveMatch(CHART[h][a], CHART[a][h]);
    }

    function saveMatch(rH, rA) {
        const hWin = cur.hGames >= rH;
        const loserGames = hWin ? cur.aGames : cur.hGames;
        const loserRace = hWin ? rA : rH;
        const loserHill = loserRace - 1;

        let pW = 2, pL = 0;
        if (loserGames === 0) { pW = 3; pL = 0; }
        else if (loserGames === loserHill) { pW = 2; pL = 1; }
        else { pW = 2; pL = 0; }
        
        const data = {
            num: cur.editingIdx > -1 ? session[cur.editingIdx].num : session.length + 1,
            hName: document.getElementById('h-name').value, aName: document.getElementById('a-name').value,
            hSl: document.getElementById('h-sl').value, aSl: document.getElementById('a-sl').value,
            hPts: hWin ? pW : pL, aPts: hWin ? pL : pW,
            score: `${cur.hGames}-${cur.aGames}`, lag: cur.lag, racks: [...cur.rackHistory]
        };

        if (cur.editingIdx > -1) session[cur.editingIdx] = data;
        else session.push(data);
        
        localStorage.setItem('mvp_session', JSON.stringify(session)); location.reload();
    }

    function confirmRack(type) {
        cur.rackHistory.push({ winner: cur.winnerSide, type, hDef: cur.hDef, aDef: cur.aDef, hTO: cur.hTO, aTO: cur.aTO, innings: cur.innings });
        cur[cur.winnerSide + 'Games']++;
        document.getElementById(cur.winnerSide + '-games').innerText = cur[cur.winnerSide + 'Games'];
        cur.hDef = cur.aDef = cur.hTO = cur.aTO = cur.innings = 0;
        ['hDef','aDef','hTO','aTO','innings'].forEach(id => document.getElementById(id + '-val').innerText = 0);
        closeM('winModal');
        updateRace();
    }

    function initEdit() {
        const m = session[cur.editingIdx];
        document.getElementById('h-name').value = m.hName; document.getElementById('a-name').value = m.aName;
        document.getElementById('h-sl').value = m.hSl; document.getElementById('a-sl').value = m.aSl;
        const scores = m.score.split('-');
        cur.hGames = parseInt(scores[0]); cur.aGames = parseInt(scores[1]);
        cur.rackHistory = m.racks; cur.lag = m.lag;
        document.getElementById('h-games').innerText = cur.hGames; document.getElementById('a-games').innerText = cur.aGames;
        document.getElementById('lag-display').innerText = `LAG: ${cur.lag.toUpperCase()}`;
        document.getElementById('match-num').innerText = m.num + " (EDITING)";
        
        // Hide normal buttons, show edit buttons
        document.getElementById('normal-actions').style.display = 'none';
        document.getElementById('edit-actions').style.display = 'block';

        closeM('detailsModal');
        updateRace();
    }

    function showDet(i) {
        cur.editingIdx = i; const m = session[i];
        let html = `<div class="detail-row"><span>Lag Winner</span><span>${m.lag.toUpperCase()}</span></div>`;
        html += `<div class="detail-row" style="font-weight:bold; color:var(--felt)"><span>Final Score</span><span>${m.score} (${m.hPts}-${m.aPts})</span></div>`;
        m.racks.forEach((r, ri) => { html += `<div class="detail-row" style="font-size:0.8rem"><span>G${ri+1}: ${r.winner.toUpperCase()} (${r.type})</span><span>Inn: ${r.innings} | D: ${r.hDef}/${r.aDef}</span></div>`; });
        document.getElementById('det-content').innerHTML = html;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    function render() {
        const list = document.getElementById('results-list'); list.innerHTML = '';
        session.forEach((m, i) => {
            const row = document.createElement('div'); row.className = 'table-row';
            row.innerHTML = `<span style="color:var(--gold);text-decoration:underline;cursor:pointer" onclick="showDet(${i})">#${m.num}</span><span>${m.hName} vs ${m.aName}</span><span>${m.score}</span><span style="color:var(--felt);font-weight:900">${m.hPts}-${m.aPts}</span>`;
            list.appendChild(row);
        });
        document.getElementById('match-num').innerText = Math.min(session.length + 1, 5);
    }

    function exportSession() { 
        let t = "MVP TV 2026 SESSION REPORT\n\n"; 
        session.forEach(m => t += `Match ${m.num}: ${m.hName} vs ${m.aName} | Score: ${m.score} | Pts: ${m.hPts}-${m.aPts}\n`); 
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(t).then(() => alert("Copied to clipboard!")); 
        } else {
            window.location.href = `mailto:?subject=APA Session Stats&body=${encodeURIComponent(t)}`;
        }
    }
    function clearSession() { if (confirm("Delete all session data? This cannot be undone.")) { localStorage.clear(); location.reload(); } }
    window.onload = () => { updateRace(); render(); };
</script>
</body>
</html>

