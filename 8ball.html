// ... (races and matches initialization remains the same)

    function upSL(i,s,v) { matches[i][s].sl=parseInt(v); refresh(); }
    function up(i,s,f,v) { matches[i][s][f]=v; localStorage.setItem(STORAGE_KEY, JSON.stringify(matches)); }
    
    // FIXED: Changed 'k' to 'f' to match function parameters
    function st(i,s,f,d) { 
        matches[i][s][f] = Math.max(0, matches[i][s][f] + d); 
        refresh(); 
    }
    
    // FIXED: Logic for innings stepper
    function stM(i,f,d) { 
        matches[i][f] = Math.max(0, matches[i][f] + d); 
        refresh(); 
    }

    function setLag(i,w) { matches[i].lag = w; refresh(); }
    function remW(i,s) { if(matches[i][s].games>0){matches[i][s].games--; matches[i][s].history.pop(); refresh();}}
    function pop(i,s) { activeWin={i,s}; document.getElementById('modal-overlay').style.display='flex'; }
    
    function recordWin(t) {
        const p = matches[activeWin.i][activeWin.s];
        const gNum = matches[activeWin.i].h.games + matches[activeWin.i].a.games + 1;
        p.games++; p.history.push(t==='Normal'?`G${gNum}`:`G${gNum}(${t})`);
        document.getElementById('modal-overlay').style.display='none'; refresh();
    }

    // ... (rest of the functions remain the same)