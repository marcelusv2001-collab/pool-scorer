<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>8 Ball 3Pt. Offline Scorekeeper</title>
    <style>
        :root { --bg: #0a0e14; --felt: #0d5a32; --gold: #ffd700; --blue: #1e3a8a; --red: #991b1b; --card: #161b22; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; touch-action: manipulation; }
        .container { max-width: 450px; margin: auto; border: 2px solid var(--felt); padding: 15px; border-radius: 12px; background: var(--card); }
        h1 { font-size: 1.1rem; text-align: center; color: var(--gold); text-transform: uppercase; margin: 0 0 15px; }
        .row { display: flex; gap: 10px; margin-bottom: 8px; }
        .header-stats { display: flex; justify-content: space-between; font-size: 0.85rem; color: #bbb; margin-bottom: 10px; font-weight: bold; }
        input, select { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #000; color: #fff; font-size: 0.9rem; }
        .lag-btn { flex: 1; padding: 8px; text-align: center; border: 2px solid #444; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .lag-btn.active { background: var(--felt); border-color: var(--gold); color: #fff; }
        .score-banner { text-align: center; font-size: 1.3rem; font-weight: 800; margin: 15px 0; color: var(--gold); border-top: 1px solid #333; padding-top: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 80px 1fr; gap: 12px; }
        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        .score-btn { padding: 22px 5px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 4px #000; }
        .h-btn { background: var(--blue); } .a-btn { background: var(--red); }
        .inn-btn { background: #333; border: 2px solid var(--gold); height: 100%; color: var(--gold); }
        .pts-box { display: flex; justify-content: space-around; margin-top: 20px; padding: 12px; background: #000; border-radius: 8px; border: 1px solid var(--felt); font-weight: bold; color: var(--gold); }
        .log { margin-top: 15px; height: 140px; overflow-y: auto; background: #000; padding: 10px; font-size: 0.8rem; border: 1px solid #333; border-radius: 5px; color: #0f0; font-family: monospace; }
        .footer-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .footer-btns button { padding: 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 5px; font-weight: bold; font-size: 0.8rem; }
        #modal, #historyView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 100; }
        .m-content { background: var(--card); padding: 20px; border-radius: 15px; border: 2px solid var(--felt); display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 85%; }
        .history-content { background: var(--card); width: 90%; padding: 20px; border-radius: 10px; color: #fff; max-height: 85vh; overflow-y: auto; border: 1px solid var(--gold); }
        .hist-item { border-bottom: 1px solid #444; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .edit-btn { background: var(--gold); color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h1>8 Ball 3Pt. Scorekeeper</h1>
    <div class="header-stats"><span id="matchCount">Match: 1/5</span><span id="race">Race: 2/2</span><span id="totalSl">SLs: H(2) A(2)</span></div>
    <div class="row"><input type="text" id="hTeam" placeholder="Home Team"><input type="text" id="aTeam" placeholder="Away Team"></div>
    <div class="row"><div class="lag-btn" id="lH" onclick="setLag('H')">LAG HOME</div><div class="lag-btn" id="lA" onclick="setLag('A')">LAG AWAY</div></div>
    <div class="row"><input type="text" id="hPlayer" placeholder="Home Player"><select id="slH" onchange="initRace()"><option value="2">SL 2</option><option value="3">SL 3</option><option value="4">SL 4</option><option value="5">SL 5</option><option value="6">SL 6</option><option value="7">SL 7</option></select></div>
    <div class="row"><input type="text" id="aPlayer" placeholder="Away Player"><select id="slA" onchange="initRace()"><option value="2">SL 2</option><option value="3">SL 3</option><option value="4">SL 4</option><option value="5">SL 5</option><option value="6">SL 6</option><option value="7">SL 7</option></select></div>
    <div class="score-banner" id="gw">GW 0/2 - 0/2</div>
    <div class="grid">
        <div class="btn-stack">
            <button class="score-btn h-btn" onmousedown="handle(event, 'toH')" ontouchstart="handle(event, 'toH')">TO: <span id="toH">0</span></button>
            <button class="score-btn h-btn" onmousedown="handle(event, 'defH')" ontouchstart="handle(event, 'defH')">DEF: <span id="defH">0</span></button>
            <button class="score-btn h-btn" onclick="openRack('H')">RACK</button>
        </div>
        <button class="score-btn inn-btn" onmousedown="handle(event, 'inn')" ontouchstart="handle(event, 'inn')">INN<br><span id="inn">0</span></button>
        <div class="btn-stack">
            <button class="score-btn a-btn" onmousedown="handle(event, 'toA')" ontouchstart="handle(event, 'toA')">TO: <span id="toA">0</span></button>
            <button class="score-btn a-btn" onmousedown="handle(event, 'defA')" ontouchstart="handle(event, 'defA')">DEF: <span id="defA">0</span></button>
            <button class="score-btn a-btn" onclick="openRack('A')">RACK</button>
        </div>
    </div>
    <div class="pts-box"><span>HOME Pts: <span id="ptsH">0</span></span><span>AWAY Pts: <span id="ptsA">0</span></span></div>
    <div class="footer-btns">
        <button onclick="endMatch()" style="background:var(--felt)">End Match</button><button onclick="resetMatch()" style="background:var(--red)">Reset Match</button>
        <button onclick="viewAll()" style="grid-column: span 2; border: 1px solid var(--gold);">View Session Summary</button>
    </div>
    <div class="log" id="matchLog">LOG: Ready...</div>
</div>

<div id="modal"><div class="m-content" id="mBtns"></div></div>
<div id="historyView"><div class="history-content"><h2 style="color:var(--gold)">Session Summary</h2><div id="historyList"></div><div id="sessionTotal" style="margin:15px 0; font-weight:bold; color:var(--gold); border-top:1px solid #444; padding-top:10px;"></div><button onclick="closeHistory()" style="width:100%; padding:12px; background:#555; color:#fff; border:none; border-radius:5px; margin-bottom:10px;">Back</button><button onclick="clearSession()" style="width:100%; padding:12px; background:var(--red); color:#fff; border:none; border-radius:5px;">Reset All</button></div></div>

<script>
const officialRace = { 2: {2:, 3:, 4:, 5:, 6:, 7:}, 3: {2:, 3:, 4:, 5:, 6:, 7:}, 4: {2:, 3:, 4:, 5:, 6:, 7:}, 5: {2:, 3:, 4:, 5:, 6:, 7:}, 6: {2:, 3:, 4:, 5:, 6:, 7:}, 7: {2:, 3:, 4:, 5:, 6:, 7:} };
let data = { toH:0, toA:0, defH:0, defA:0, inn:0, gwH:0, gwA:0, reqH:2, reqA:2, logs: [], totDefH:0, totDefA:0, totInn:0 };
let session = JSON.parse(localStorage.getItem('apa_session')) || [];
let clickTimer = null;

function initRace() {
    const h = parseInt(document.getElementById('slH').value), a = parseInt(document.getElementById('slA').value);
    [data.reqH, data.reqA] = officialRace[h][a];
    document.getElementById('race').innerText = `Race: ${data.reqH}/${data.reqA}`;
    document.getElementById('totalSl').innerText = `SLs: H(${h}) A(${a})`;
    document.getElementById('matchCount').innerText = `Match: ${session.length + 1}/5`;
    updateUI();
}

function handle(e, key) {
    e.preventDefault();
    if (key.includes('to')) {
        const sl = parseInt(document.getElementById(key === 'toH' ? 'slH' : 'slA').value);
        const limit = sl <= 3 ? 2 : 1; 
        if (clickTimer === null && data[key] >= limit && e.type !== 'touchstart') { alert(`Limit ${limit} reached!`); return; }
    }
    if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; data[key] = Math.max(0, data[key] - 1); } 
    else {
        const lp = setTimeout(() => { data[key] = 0; updateUI(); clickTimer = null; }, 600);
        clickTimer = setTimeout(() => { if (clickTimer) { data[key]++; updateUI(); clickTimer = null; } }, 250);
        e.target.onmouseup = e.target.ontouchend = () => clearTimeout(lp);
    }
    updateUI();
}

function openRack(side) {
    if ((side === 'H' && data.gwH >= data.reqH) || (side === 'A' && data.gwA >= data.reqA)) return alert("Match finished.");
    data.activeSide = side; 
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('mBtns').innerHTML = ['Win','8BB','B&R','WP','E8','S8','CANCEL'].map(opt => `<button onclick="submitRack('${opt}')">${opt}</button>`).join('');
}

function submitRack(type) {
    if(type === 'CANCEL') return document.getElementById('modal').style.display = 'none';
    let markedInn = (type === '8BB' || type === 'B&R') ? 0 : data.inn;
    if(data.activeSide === 'H') data.gwH++; else data.gwA++;
    data.totDefH += data.defH; data.totDefA += data.defA; data.totInn += markedInn;
    data.logs.push(`G${data.gwH+data.gwA}(${data.activeSide}):${type} I:${markedInn} D:${data.defH}/${data.defA}`);
    data.defH = 0; data.defA = 0; data.inn = 0; data.toH = 0; data.toA = 0;
    calcMatchPts(); updateUI();
    document.getElementById('modal').style.display = 'none';
}

function calcMatchPts() {
    let pH = 0, pA = 0;
    if (data.gwH >= data.reqH) {
        if (data.gwA === 0) pH = 3; else if (data.gwA === data.reqA - 1) { pH = 2; pA = 1; } else pH = 2;
    } else if (data.gwA >= data.reqA) {
        if (data.gwH === 0) pA = 3; else if (data.gwH === data.reqH - 1) { pA = 2; pH = 1; } else pA = 2;
    }
    document.getElementById('ptsH').innerText = pH; document.getElementById('ptsA').innerText = pA;
    return [pH, pA];
}

function updateUI() {
    ['toH','toA','defH','defA','inn'].forEach(k => document.getElementById(k).innerText = data[k]);
    document.getElementById('gw').innerText = `GW ${data.gwH}/${data.reqH} - ${data.gwA}/${data.reqA}`;
    document.getElementById('matchLog').innerHTML = `T-Def: ${data.totDefH}/${data.totDefA} | T-Inn: ${data.totInn}<br>` + data.logs.join('<br>');
}

function endMatch() {
    if (data.gwH < data.reqH && data.gwA < data.reqA) return alert("Match not finished.");
    if (session.length >= 5) return alert("Session Full.");
    const pts = calcMatchPts();
    session.push({ h: document.getElementById('hPlayer').value || "H", a: document.getElementById('aPlayer').value || "A", score: `${data.gwH}-${data.gwA}`, pts: pts, logs: [...data.logs] });
    localStorage.setItem('apa_session', JSON.stringify(session));
    location.reload();
}

function resetMatch() { if(confirm("Reset current match?")) { data.gwH = 0; data.gwA = 0; data.logs = []; updateUI(); } }
function viewAll() { document.getElementById('historyView').style.display = 'flex'; renderHistory(); }
function closeHistory() { document.getElementById('historyView').style.display = 'none'; }
function renderHistory() {
    let th = 0, ta = 0;
    document.getElementById('historyList').innerHTML = session.map((m,i)=>{
        th += m.pts; ta += m.pts;
        return `<div class="hist-item"><div><b>M${i+1}: ${m.h} vs ${m.a}</b><br>Score: ${m.score} | Pts: ${m.pts}-${m.pts}</div><button class="edit-btn" onclick="editMatchInHistory(${i})">Edit</button></div>`;
    }).join('') || "No matches yet.";
    document.getElementById('sessionTotal').innerText = `SESSION TOTAL: Home ${th} | Away ${ta}`;
}
function editMatchInHistory(idx) { let n = prompt("Edit Log (comma separated):", session[idx].logs.join(', ')); if(n) { session[idx].logs = n.split(',').map(s=>s.trim()); localStorage.setItem('apa_session', JSON.stringify(session)); renderHistory(); } }
function clearSession() { if(confirm("Clear ALL data?")) { localStorage.clear(); location.reload(); } }
function setLag(s) { document.getElementById('lH').className = s === 'H' ? 'lag-btn active' : 'lag-btn'; document.getElementById('lA').className = s === 'A' ? 'lag-btn active' : 'lag-btn'; }
initRace();
</script>
</body>
</html>
