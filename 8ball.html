<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP TV 8 Ball 3 Pt. Offline Scorekeeper</title>
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        :root { 
            --felt: #2d5a27; --slate: #1a1a1a; --wood: #5d4037; 
            --gold: #f1c40f; --chalk: #3498db; --ball-8: #2c3e50; --danger: #e74c3c;
            --active-bg: #ffffff; 
            --app-bg: #ffebee; /* Light Red Background */
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--slate); 
            background-image: radial-gradient(circle, #3d7a35 0%, #1a3a16 100%);
            margin: 0; padding: 10px; color: #333; /* Default body color adjusted for light red bg */
        }
        .branding { text-align: center; margin-bottom: 10px; position: relative; }
        .logo-box { background: white; padding: 5px 15px; display: inline-block; border-radius: 12px; }
        .logo-mvp { color:#00FF00; font-size: 24px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 32px; font-style: italic; font-weight: 900; font-family: 'Brush Script MT', cursive; margin-left: -5px; }
        .title { display: block; font-size: 0.9rem; color: #555; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* Mobile Optimization & Light Red BG */
        .app-container { 
            background: var(--app-bg); 
            border-radius: 15px; padding: 15px; color: #333; 
            max-width: 600px; margin: auto; 
            width: 100%; min-height: 90vh; /* Fit mobile screen height */
        }
        
        .header-actions { position: absolute; top: 0; right: 0; display: flex; gap: 5px; font-size: 0.75rem;}

        .team-input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .team-box { background: #f0f0f0; padding: 10px; border-radius: 8px; }
        .team-name { width: 100%; border: none; font-weight: 800; font-size: 0.9rem; background: transparent; }
        .player-row { display: flex; align-items: center; gap: 5px; margin-top: 8px; }
        .player-name { flex-grow: 1; border: none; border-bottom: 1px solid #ddd; background: transparent; }
        .skill-level { width: 45px; padding: 5px; border-radius: 5px; }
        
        .race-chart-info { background: var(--ball-8); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; font-weight: bold; }
        
        .controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; margin-bottom: 10px; }
        .side-controls { display: flex; flex-direction: column; gap: 8px; }
        .inning-control { display: flex; justify-content: center; align-items: center; margin-top: 5px; }

        /* Billiard Ball Style Buttons */
        .btn-8ball { 
            background: var(--ball-8); color: white; border: none; 
            border-radius: 50%; width: 45px; height: 45px; font-weight: bold; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center;
        }
        .btn-8ball::before { content: attr(data-label); position: absolute; top: -15px; font-size: 0.6rem; text-transform: uppercase; color: #333; }
        .btn-8ball.win { background: var(--felt); width: 60px; height: 60px; }
        .btn-8ball.win::before { top: -18px; }

        .btn-action { background: #555; color: white; padding: 8px; border-radius: 8px; border: none; cursor: pointer; }
        
        .match-status { text-align: center; margin-bottom: 10px; font-weight: bold; color: var(--danger); }
        .match-status.active { color: var(--felt); }
        
        .history-log { border-top: 1px solid #eee; padding-top: 10px; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; }
        .winner-highlight { font-weight: bold; color: var(--gold); }
        
        .final-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }

        /* Modal for Win Options */
        #win-modal {
            display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--app-bg); padding: 20px; border-radius: 10px; text-align: center; width: 90%; max-width: 300px;
        }
        .win-option-btn {
            background-color: var(--ball-8); color: white; padding: 10px; margin: 5px 0; border: none; border-radius: 5px; width: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
    <span class="title">8 Ball 3 Pt. Offline Scorekeeper</span>
    <div class="header-actions">
        <button class="btn-action" onclick="toggleEditMode()">EDIT</button>
        <button class="btn-action" onclick="finishMatch()">FINISH MATCH</button>
    </div>
</div>

<div class="app-container" id="capture-area">
    <div class="team-input-grid">
        <div class="team-box">
            <input type="text" class="team-name" id="home-team" placeholder="HOME TEAM">
            <div class="player-row">
                <input type="text" class="player-name" id="home-player" placeholder="Player Name">
                <select class="skill-level" id="home-sl" onchange="updateRace()">
                    <option value="2">SL2</option><option value="3">SL3</option>
                    <option value="4">SL4</option><option value="5">SL5</option>
                    <option value="6">SL6</option><option value="7">SL7</option>
                </select>
            </div>
        </div>
        <div class="team-box">
            <input type="text" class="team-name" id="away-team" placeholder="AWAY TEAM">
            <div class="player-row">
                <input type="text" class="player-name" id="away-player" placeholder="Player Name">
                <select class="skill-level" id="away-sl" onchange="updateRace()">
                    <option value="2">SL2</option><option value="3">SL3</option>
                    <option value="4">SL4</option><option value="5">SL5</option>
                    <option value="6">SL6</option><option value="7">SL7</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="race-chart-info" id="race-info">
        Race: Home needs 0 wins vs Away needs 0 wins (SL Diff: 0)
    </div>

    <div class="match-status active" id="match-status">MATCH IN PROGRESS</div>

    <div class="controls-grid" id="controls">
        <div class="side-controls home-controls">
            <button class="btn-8ball" data-label="Defense" onclick="adj('home', 'def', 1)">D</button>
            <button class="btn-8ball" data-label="Timeout" onclick="adj('home', 'to', 1)">T</button>
            <button class="btn-8ball win" data-label="WIN" onclick="promptWin('home')">W</button>
        </div>
        <div class="inning-control">
            <button class="btn-action" onclick="adj('both', 'inn', 1)">INNING <span id="cur-inn">0</span></button>
        </div>
        <div class="side-controls away-controls">
            <button class="btn-8ball" data-label="Defense" onclick="adj('away', 'def', 1)">D</button>
            <button class="btn-8ball" data-label="Timeout" onclick="adj('away', 'to', 1)">T</button>
            <button class="btn-8ball win" data-label="WIN" onclick="promptWin('away')">W</button>
        </div>
    </div>

    <div class="history-log" id="history">
        <!-- Game logs and totals appear here -->
    </div>
    
    <div class="final-actions" id="final-actions" style="display: none;">
        <button class="btn-action" onclick="saveScreenshot()">Screenshot</button>
        <button class="btn-action" onclick="copyToClipboard()">Save to Clipboard</button>
        <button class="btn-action" onclick="exportTxt()">Export TXT</button>
    </div>
</div>

<!-- Win Options Modal (New Feature) -->
<div id="win-modal">
    <div class="modal-content">
        <h4 style="margin-bottom: 15px;">Select Win Type</h4>
        <button class="win-option-btn" onclick="recordGame(modalSide, 'Normal')">Normal</button>
        <button class="win-option-btn" onclick="recordGame(modalSide, 'B&R')">B&R</button>
        <button class="win-option-btn" onclick="recordGame(modalSide, '8BB')">8BB</button>
        <button class="win-option-btn" onclick="recordGame(modalSide, 'E8')">E8</button>
        <button class="win-option-btn" onclick="recordGame(modalSide, 'S8')">S8</button>
        <button class="win-option-btn" onclick="recordGame(modalSide, 'WP')">WP</button>
        <button class="win-option-btn" style="background-color: var(--danger);" onclick="document.getElementById('win-modal').style.display='none'">Cancel</button>
    </div>
</div>

<script>
    // APA Race Chart [Home SL][Away SL] = Race To Games
    // This is the actual APA chart data obtained via search results
    const RaceChart = {
        2: { 2: 2, 3: 2, 4: 2, 5: 2, 6: 2, 7: 2 },
        3: { 2: 3, 3: 3, 4: 3, 5: 3, 6: 3, 7: 3 },
        4: { 2: 4, 3: 4, 4: 4, 5: 4, 6: 4, 7: 4 },
        5: { 2: 5, 3: 5, 4: 5, 5: 5, 6: 5, 7: 5 },
        6: { 2: 6, 3: 6, 4: 6, 5: 6, 6: 6, 7: 6 },
        7: { 2: 7, 3: 7, 4: 7, 5: 7, 6: 7, 7: 7 }
    };

    let matchData = {
        status: 'active',
        home: { sl: 2, games_won: 0, history: [], def: 0, to: 0, points: 0 },
        away: { sl: 2, games_won: 0, history: [], def: 0, to: 0, points: 0 },
        current: { inn: 0 },
        race_home: 0, race_away: 0,
    };
    let modalSide = ''; // To track which side initiated the win modal

    function updateRace() {
        const homeSL = parseInt(document.getElementById('home-sl').value);
        const awaySL = parseInt(document.getElementById('away-sl').value);
        matchData.home.sl = homeSL;
        matchData.away.sl = awaySL;
        // The race is always based on the higher SL number vs the lower SL's "games to win" for their race
        matchData.race_home = RaceChart[Math.max(homeSL, awaySL)][awaySL];
        matchData.race_away = RaceChart[Math.max(homeSL, awaySL)][homeSL];
        renderUI();
    }

    function adj(side, field, val) {
        if (matchData.status !== 'active') return;
        if (side === 'both') {
            matchData.current[field] = Math.max(0, matchData.current[field] + val);
        } else {
            matchData[side][field] = Math.max(0, matchData[side][field] + val);
        }
        renderUI();
    }

    // Opens the modal with 5 win options
    function promptWin(winnerSide) {
        if (matchData.status !== 'active') return;
        modalSide = winnerSide;
        document.getElementById('win-modal').style.display = 'flex';
    }

    function recordGame(winnerSide, winType) {
        document.getElementById('win-modal').style.display = 'none'; // Close modal
        const gameNum = matchData.home.history.length + matchData.away.history.length + 1;
        
        // Log format: g1(B&R) 2in. 1def. 1to.
        const logEntry = `g${gameNum}${winType !== 'Normal' ? `(${winType})` : ''} ${matchData.current.inn}in. ${matchData[winnerSide].def}def. ${matchData[winnerSide].to}to.`;
        matchData[winnerSide].history.push(logEntry);
        
        // Update game counts
        matchData[winnerSide].games_won++;

        // Reset current game stats
        matchData.current.inn = 0;
        matchData.home.def = 0; matchData.home.to = 0;
        matchData.away.def = 0; matchData.away.to = 0;

        // Check for match end
        if (matchData[winnerSide].games_won >= matchData[`race_${winnerSide}`]) {
            calculatePoints();
            matchData.status = 'finished';
        }

        renderUI();
    }
    
    function calculatePoints() {
        const homeGames = matchData.home.games_won;
        const awayGames = matchData.away.games_won;
        
        if (homeGames > awayGames) {
            // Home wins. If away reached "hill" (race_away - 1), it's 2-1 points. Otherwise 3-0.
            matchData.home.points = awayGames === matchData.race_away - 1 ? 2 : 3;
            matchData.away.points = awayGames === matchData.race_away - 1 ? 1 : 0;
        } else {
            // Away wins. If home reached "hill" (race_home - 1), it's 2-1 points. Otherwise 3-0.
            matchData.away.points = homeGames === matchData.race_home - 1 ? 2 : 3;
            matchData.home.points = homeGames === matchData.race_home - 1 ? 1 : 0;
        }
    }


    function renderUI() {
        document.getElementById('race-info').innerText = 
            `Race: Home needs ${matchData.race_home} wins vs Away needs ${matchData.race_away} wins`;

        document.getElementById('cur-inn').innerText = matchData.current.inn;

        const statusEl = document.getElementById('match-status');
        const controlsEl = document.getElementById('controls');
        const finalActionsEl = document.getElementById('final-actions');
        if (matchData.status === 'finished') {
            statusEl.innerText = 'MATCH FINISHED';
            statusEl.classList.remove('active');
            controlsEl.style.display = 'none';
            finalActionsEl.style.display = 'grid';
        } else {
            statusEl.innerText = 'MATCH IN PROGRESS';
            statusEl.classList.add('active');
            controlsEl.style.display = 'grid';
            finalActionsEl.style.display = 'none';
        }

        const historyEl = document.getElementById('history');
        let historyHTML = '';
        const homeName = document.getElementById('home-player').value || 'HOME PLAYER';
        const awayName = document.getElementById('away-player').value || 'AWAY PLAYER';

        if (matchData.status === 'finished') {
            const homeTotalInn = matchData.home.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)in\./)[1] || 0), 0);
            const homeTotalDef = matchData.home.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)def\./)[1] || 0), 0);
            const homeTotalTO = matchData.home.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)to\./)[1] || 0), 0);
            const awayTotalInn = matchData.away.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)in\./)[1] || 0), 0);
            const awayTotalDef = matchData.away.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)def\./)[1] || 0), 0);
            const awayTotalTO = matchData.away.history.reduce((sum, entry) => sum + parseInt(entry.match(/(\d+)to\./)[1] || 0), 0);
            const totalGames = matchData.home.games_won + matchData.away.games_won;

            const homeWin = matchData.home.points > matchData.away.points;
            
            historyHTML += `<div style="margin-bottom: 10px;">MATCH RESULT: <span class="${homeWin ? 'winner-highlight' : ''}">${homeName} ${matchData.home.points}pts</span> vs <span class="${!homeWin ? 'winner-highlight' : ''}">${awayName} ${matchData.away.points}pts</span></div>`;
            historyHTML += `<div>${homeName}: ${matchData.home.history.join(', ')}</div>`;
            historyHTML += `<div>${awayName}: ${matchData.away.history.join(', ')}</div>`;
            historyHTML += `<div style="margin-top: 10px; font-weight: bold;">TOTALS: Games = ${totalGames}, Innings = ${homeTotalInn + awayTotalInn}, Defense = ${homeTotalDef + awayTotalDef}</div>`;
        } else {
            historyHTML = 'Match history will appear here once games are won.';
        }
        document.getElementById('history').innerHTML = historyHTML;

        toggleEditMode(true);
    }

    function finishMatch() {
        if (matchData.status !== 'active') return;
        if (confirm("Are you sure you want to finish the match? Points will be calculated based on current games won.")) {
            calculatePoints();
            matchData.status = 'finished';
            renderUI();
        }
    }

    function toggleEditMode(autoDisable = false) {
        const inputs = document.querySelectorAll('input, select');
        const isFinished = matchData.status === 'finished';
        const editButton = document.querySelector('.header-actions .btn-action');
        const isEditMode = editButton.innerText === 'DONE';

        if (autoDisable) {
            inputs.forEach(input => input.disabled = isFinished);
        } else {
            const newMode = !isEditMode;
            editButton.innerText = newMode ? 'DONE' : 'EDIT';
            inputs.forEach(input => input.disabled = !newMode && !isFinished);
        }
    }

    function saveScreenshot() {
        html2canvas(document.getElementById('capture-area'), { backgroundColor: '#ffebee' }).then(canvas => {
            const link = document.createElement('a');
            link.download = `MVP-Scorecard-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function copyToClipboard() {
        const historyText = document.getElementById('history').innerText;
        navigator.clipboard.writeText(historyText).then(() => {
            alert('Score copied to clipboard!');
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    }

    function exportTxt() {
        const historyText = document.getElementById('history').innerText;
        const blob = new Blob([historyText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `MVP-Scorecard-${Date.now()}.txt`;
        link.click();
        URL.revokeObjectURL(url);
    }

    // Initial render
    updateRace();
</script>

</body>
</html>
