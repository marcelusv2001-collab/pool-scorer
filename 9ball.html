<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billiards Scorekeeper PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --slate: #1a1a1a; --gold: #f1c40f; --purple: #6a0dad; --danger: #e74c3c; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--slate); margin: 0; padding: 10px; color: #fff; }
        
        #custom-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: #fff; color: #000; margin: 20% auto; padding: 25px; border-radius: 15px; width: 85%; text-align: center; border: 5px solid var(--purple); }
        .modal-btn { padding: 15px 20px; margin: 10px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; color: white; min-width: 100px; font-size: 1rem; }

        .branding { text-align: center; margin-bottom: 10px; }
        .logo-box { background: white; padding: 8px 20px; border-radius: 12px; border: 3px solid var(--gold); display: inline-block; }
        .logo-mvp { color:#00FF00; font-size: 26px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 34px; font-style: italic; font-weight: 900; margin-left: -5px; }
        
        .match-card { border-radius: 15px; margin-bottom: 15px; overflow: hidden; color: #333; background: white; border: 2px solid var(--gold); }
        .card-done { border-left: 12px solid var(--purple); opacity: 0.98; }
        
        .head-active { background: var(--gold); color: #000; padding: 12px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        
        .ball-container { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 12px 0; }
        .ball { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #aaa; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; color: #fff; cursor: pointer; text-shadow: 1px 1px 1px #000; transition: transform 0.1s; }
        
        .b1, .b9 { background: #ffea00; color: #000; text-shadow: none; } .b9 { border: 2px dashed #000; }
        .b2 { background: #0052cc; } .b3 { background: #cc0000; } .b4 { background: #4b0082; }
        .b5 { background: #ff8c00; } .b6 { background: #008000; } .b7 { background: #8b4513; } .b8 { background: #000; }

        .ball-selected { background: #ffffff !important; color: var(--purple) !important; border: 3px solid var(--purple) !important; text-shadow: none !important; transform: scale(1.15); box-shadow: 0 4px 10px rgba(106, 13, 173, 0.4); }
        .ball-dead { background: #333 !important; color: #ff0000 !important; border: 2px dashed #ff0000 !important; opacity: 0.4; text-shadow: none !important; }

        .to-btn { background: #fff; border: 2px solid #ddd; padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; font-weight: 900; cursor: pointer; }
        .to-used { background: var(--danger); color: white; border-color: var(--danger); }
        
        .total-score-bar { background: #000; color: var(--gold); padding: 20px; border-radius: 15px; margin: 15px 0; display: grid; grid-template-columns: 1fr auto 1fr; text-align: center; border: 3px solid var(--gold); }
        .action-btn { width: 100%; padding: 20px; border: none; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; margin-top: 10px; font-size: 1.1rem; }
        
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-bottom: 6px; font-weight: 900; }
        .stat-line { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 0.9rem; line-height: 1.4; }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-content">
        <h2 id="modal-title" style="margin:0;"></h2>
        <p id="modal-text" style="font-weight:bold;"></p>
        <div id="modal-actions"></div>
    </div>
</div>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
    <input id="team-h" placeholder="HOME TEAM" oninput="saveG()">
    <input id="team-a" placeholder="AWAY TEAM" oninput="saveG()">
</div>

<div id="capture-area">
    <div id="match-container"></div>
    <div class="total-score-bar">
        <div><small id="disp-h">HOME</small><div id="h-total" style="font-size:3rem;">0</div></div>
        <div style="padding: 0 15px; border-left: 2px solid #333; border-right: 2px solid #333; display: flex; align-items: center; font-weight: 900;">TOTAL<br>POINTS</div>
        <div><small id="disp-a">AWAY</small><div id="a-total" style="font-size:3rem;">0</div></div>
    </div>
</div>

<button class="action-btn" style="background:var(--gold); color:#000;" onclick="addMatch()">+ New Match</button>
<button class="action-btn" style="background:#3498db;" onclick="exportJPG()">Save Image</button>

<script>
    const races = { 1:14, 2:19, 3:25, 4:31, 5:38, 6:46, 7:55, 8:65, 9:75 };
    const chart = {
        1: [ {m:2, p:20}, {m:3, p:19}, {m:4, p:18}, {m:6, p:17}, {m:7, p:16}, {m:8, p:15}, {m:10, p:14}, {m:11, p:13}, {m:13, p:12} ],
        2: [ {m:3, p:20}, {m:5, p:19}, {m:7, p:18}, {m:8, p:17}, {m:10, p:16}, {m:12, p:15}, {m:14, p:14}, {m:16, p:13}, {m:18, p:12} ],
        3: [ {m:4, p:20}, {m:6, p:19}, {m:9, p:18}, {m:11, p:17}, {m:14, p:16}, {m:16, p:15}, {m:19, p:14}, {m:21, p:13}, {m:24, p:12} ],
        4: [ {m:5, p:20}, {m:8, p:19}, {m:11, p:18}, {m:14, p:17}, {m:18, p:16}, {m:21, p:15}, {m:24, p:14}, {m:27, p:13}, {m:30, p:12} ],
        5: [ {m:6, p:20}, {m:10, p:19}, {m:14, p:18}, {m:18, p:17}, {m:22, p:16}, {m:26, p:15}, {m:29, p:14}, {m:33, p:13}, {m:37, p:12} ],
        6: [ {m:8, p:20}, {m:12, p:19}, {m:17, p:18}, {m:22, p:17}, {m:27, p:16}, {m:31, p:15}, {m:36, p:14}, {m:40, p:13}, {m:45, p:12} ],
        7: [ {m:10, p:20}, {m:15, p:19}, {m:21, p:18}, {m:26, p:17}, {m:32, p:16}, {m:37, p:15}, {m:43, p:14}, {m:49, p:13}, {m:54, p:12} ],
        8: [ {m:13, p:20}, {m:19, p:19}, {m:26, p:18}, {m:32, p:17}, {m:39, p:16}, {m:45, p:15}, {m:52, p:14}, {m:58, p:13}, {m:64, p:12} ],
        9: [ {m:17, p:20}, {m:24, p:19}, {m:31, p:18}, {m:38, p:17}, {m:46, p:16}, {m:53, p:15}, {m:60, p:14}, {m:67, p:13}, {m:74, p:12} ]
    };

    let matches = JSON.parse(localStorage.getItem('billiard_vFinal_0Err')) || [];
    let lastT = { time: 0, b: null, s: null };

    function showM(title, text, btns) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        const d = document.getElementById('modal-actions'); d.innerHTML = '';
        btns.forEach(b => {
            const e = document.createElement('button'); e.className = 'modal-btn';
            e.style.background = b.color || '#333'; e.innerText = b.text;
            e.onclick = () => { document.getElementById('custom-modal').style.display='none'; b.f(); };
            d.appendChild(e);
        });
        document.getElementById('custom-modal').style.display = 'block';
    }

    function saveG() {
        localStorage.setItem('team_h', document.getElementById('team-h').value);
        localStorage.setItem('team_a', document.getElementById('team-a').value);
        document.getElementById('disp-h').innerText = document.getElementById('team-h').value || "HOME";
        document.getElementById('disp-a').innerText = document.getElementById('team-a').value || "AWAY";
    }

    function refresh() {
        localStorage.setItem('billiard_vFinal_0Err', JSON.stringify(matches));
        const c = document.getElementById('match-container'); c.innerHTML = '';
        let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            const hPt = getPts('h', i); const aPt =