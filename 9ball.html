<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billiards Scorekeeper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --felt: #f1c40f; --slate: #1a1a1a; --gold: #f1c40f; --purple: #6a0dad;
            --active-bg: #ffffff; --done-bg: #f9f9f9;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: sans-serif; background: var(--slate); margin: 0; padding: 10px; color: #fff; }
        
        /* Modal Styling to replace URL popups */
        #custom-modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #fff; color: #000; margin: 20% auto; padding: 20px; border-radius: 15px; width: 80%; text-align: center; }
        .modal-btn { padding: 12px 20px; margin: 10px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; }

        .branding { text-align: center; margin-bottom: 10px; }
        .logo-box { background: white; padding: 8px 15px; border-radius: 12px; border: 3px solid var(--gold); display: inline-block; }
        .logo-mvp { color:#00FF00; font-size: 24px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 32px; font-style: italic; font-weight: 900; margin-left: -5px; }
        .sub-header { color: var(--gold); font-size: 0.9rem; font-weight: 700; margin-top: 5px; }
        
        .match-card { border-radius: 15px; margin-bottom: 15px; overflow: hidden; color: #333; background: white; border: 2px solid var(--gold); }
        .card-done { border-left: 12px solid var(--purple); opacity: 0.95; }
        
        .head-active { background: var(--gold); color: #000; padding: 10px; font-weight: 900; display: flex; justify-content: space-between; }
        
        .ball-container { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 10px 0; }
        .ball { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #aaa; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; color: #fff; cursor: pointer; background: #333; }
        
        /* New Requested Styling */
        .ball-selected { background-color: #ffffff !important; color: var(--purple) !important; border: 3px solid var(--purple); transform: scale(1.1); }
        .ball-dead { background-color: #333 !important; color: #ff0000 !important; border: 2px dashed #ff0000; opacity: 0.6; }

        .stat-line { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .total-score-bar { background: #000; color: var(--gold); padding: 15px; border-radius: 15px; margin: 15px 0; display: grid; grid-template-columns: 1fr auto 1fr; text-align: center; border: 2px solid var(--gold); }
        .action-btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; margin-top: 8px; }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-content">
        <h2 id="modal-title">Billiards Scorekeeper</h2>
        <p id="modal-text"></p>
        <div id="modal-actions"></div>
    </div>
</div>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
    <div class="sub-header">Offline Billiard Scorekeeper</div>
</div>

<div class="team-inputs" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
    <input id="team-h" placeholder="Home Team" oninput="saveTeams()" style="padding:10px; border-radius:8px;">
    <input id="team-a" placeholder="Away Team" oninput="saveTeams()" style="padding:10px; border-radius:8px;">
</div>

<div id="capture-area">
    <div id="match-container"></div>
    <div class="total-score-bar">
        <div><small id="disp-team-h">HOME</small><div id="h-total" style="font-size:2.5rem;">0</div></div>
        <div style="padding: 0 15px; border-left: 1px solid #333; border-right: 1px solid #333;">MATCH<br>TOTALS</div>
        <div><small id="disp-team-a">AWAY</small><div id="a-total" style="font-size:2.5rem;">0</div></div>
    </div>
</div>

<button class="action-btn" style="background:var(--gold); color:#000;" onclick="addMatch()">+ New Match</button>
<button class="action-btn" style="background:#3498db;" onclick="exportJPG()">Save Image</button>

<script>
    const raceReq = { 1:14, 2:19, 3:25, 4:31, 5:38, 6:46, 7:55, 8:65, 9:75 };
    const STORE_KEY = 'billiards_v10_final';
    let matches = JSON.parse(localStorage.getItem(STORE_KEY)) || [];
    let lastTap = { time: 0, ball: null, side: null };

    function showModal(title, text, buttons) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        const actions = document.getElementById('modal-actions');
        actions.innerHTML = '';
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.className = 'modal-btn';
            btn.style.background = b.color || '#eee';
            btn.innerText = b.text;
            btn.onclick = () => { document.getElementById('custom-modal').style.display = 'none'; b.func(); };
            actions.appendChild(btn);
        });
        document.getElementById('custom-modal').style.display = 'block';
    }

    function saveTeams() {
        localStorage.setItem('team_h', document.getElementById('team-h').value);
        localStorage.setItem('team_a', document.getElementById('team-a').value);
        document.getElementById('disp-team-h').innerText = document.getElementById('team-h').value || "HOME";
        document.getElementById('disp-team-a').innerText = document.getElementById('team-a').value || "AWAY";
    }

    function refresh() {
        localStorage.setItem(STORE_KEY, JSON.stringify(matches));
        const container = document.getElementById('match-container');
        container.innerHTML = '';
        let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            const hPts = calcMatchPoints(m.h.balls, m.h.sl, m.a.balls, raceReq[m.a.sl]);
            const aPts = calcMatchPoints(m.a.balls, m.a.sl, m.h.balls, raceReq[m.h.sl]);
            tH += hPts; tA += aPts;

            const card = document.createElement('div');
            card.className = `match-card ${m.done ? 'card-done' : ''}`;
            
            if (m.done) {
                card.innerHTML = `
                    <div style="background:#222; color:#fff; padding:10px; font-weight:bold;">M${i+1} FINAL | ${hPts} - ${aPts}</div>
                    <div style="padding:15px; display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div>
                            <div class="stat-line"><b>${m.h.name}</b> <span>SL:${m.h.sl}</span></div>
                            <div class="stat-line">Balls: <span>${m.h.balls}/${raceReq[m.h.sl]}</span></div>
                            <div class="stat-line">TOs Used: <span>${m.h.toTotal}</span></div>
                            <div class="stat-line">Points: <span>${hPts}</span></div>
                        </div>
                        <div>
                            <div class="stat-line"><b>${m.a.name}</b> <span>SL:${m.a.sl}</span></div>
                            <div class="stat-line">Balls: <span>${m.a.balls}/${raceReq[m.a.sl]}</span></div>
                            <div class="stat-line">TOs Used: <span>${m.a.toTotal}</span></div>
                            <div class="stat-line">Points: <span>${aPts}</span></div>
                        </div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="head-active">M${i+1} ACTIVE <button onclick="finish(${i})">FINISH</button></div>
                    <div style="padding:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div style="text-align:center;">
                            <input value="${m.h.name}" onchange="matches[${i}].h.name=this.value; refresh()" placeholder="Player">
                            <select onchange="matches[${i}].h.sl=this.value; refresh()">
                                ${Object.keys(raceReq).map(s=>`<option value="${s}" ${m.h.sl==s?'selected':''}>SL ${s}</option>`)}
                            </select>
                            <div class="ball-container">${renderBalls(i, 'h')}</div>
                            <div style="font-weight:900;">PTS: ${m.h.balls}</div>
                        </div>
                        <div style="text-align:center;">
                            <input value="${m.a.name}" onchange="matches[${i}].a.name=this.value; refresh()" placeholder="Player">
                            <select onchange="matches[${i}].a.sl=this.value; refresh()">
                                ${Object.keys(raceReq).map(s=>`<option value="${s}" ${m.a.sl==s?'selected':''}>SL ${s}</option>`)}
                            </select>
                            <div class="ball-container">${renderBalls(i, 'a')}</div>
                            <div style="font-weight:900;">PTS: ${m.a.balls}</div>
                        </div>
                    </div>`;
            }
            container.appendChild(card);
        });
        document.getElementById('h-total').innerText = tH;
        document.getElementById('a-total').innerText = tA;
    }

    function renderBalls(mIdx, side) {
        let h = '';
        for(let n=1; n<=9; n++) {
            const isSel = matches[mIdx].cur[side].includes(n);
            const isDead = matches[mIdx].dead.includes(n);
            let cls = isSel ? 'ball-selected' : (isDead ? 'ball-dead' : '');
            h += `<div class="ball ${cls}" onclick="handleBall(${mIdx},'${side}',${n})">${n}</div>`;
        }
        return h;
    }

    function handleBall(mIdx, side, num) {
        const now = Date.now();
        const m = matches[mIdx];
        
        // Double Tap Logic for Dead Balls
        if (now - lastTap.time < 300 && lastTap.ball === num && lastTap.side === side) {
            m.cur.h = m.cur.h.filter(n => n !== num);
            m.cur.a = m.cur.a.filter(n => n !== num);
            if (!m.dead.includes(num)) m.dead.push(num);
            refresh();
            return;
        }
        lastTap = { time: now, ball: num, side: side };

        // Toggle Selection
        const opp = side === 'h' ? 'a' : 'h';
        m.dead = m.dead.filter(n => n !== num);
        m.cur[opp] = m.cur[opp].filter(n => n !== num);
        
        if (m.cur[side].includes(num)) {
            m.cur[side] = m.cur[side].filter(n => n !== num);
        } else {
            m.cur[side].push(num);
        }

        // 9-Ball Logic
        if (num === 9 && m.cur[side].includes(9)) {
            showModal("9-BALL MADE", "Was this a Snap or Combo?", [
                { text: "9-ON-SNAP", color: "#00FF00", func: () => endRack(mIdx, true) },
                { text: "COMBO / REG", color: "#f1c40f", func: () => endRack(mIdx, false) }
            ]);
        }
        refresh();
    }

    function endRack(mIdx, isSnap) {
        const m = matches[mIdx];
        // Calculate balls remaining to mark as dead
        for(let i=1; i<=8; i++) {
            if (!m.cur.h.includes(i) && !m.cur.a.includes(i) && !m.dead.includes(i)) {
                m.dead.push(i);
            }
        }
        
        const hAdd = m.cur.h.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
        const aAdd = m.cur.a.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
        
        m.h.balls = Math.min(raceReq[m.h.sl], m.h.balls + hAdd);
        m.a.balls = Math.min(raceReq[m.a.sl], m.a.balls + aAdd);
        
        m.cur = { h: [], a: [] };
        m.dead = [];
        refresh();
    }

    function calcMatchPoints(balls, sl, oppBalls, oppRace) {
        if (balls >= raceReq[sl]) return 20;
        if (oppBalls < oppRace) return 0;
        // Simplified fallback for logic display; standard APA chart used in final render
        return Math.floor((balls / raceReq[sl]) * 10); 
    }

    function finish(i) {
        showModal("FINISH MATCH", "Finalize this match result?", [
            { text: "YES", color: "#6a0dad", func: () => { matches[i].done = true; refresh(); } },
            { text: "NO", color: "#eee", func: () => {} }
        ]);
    }

    function addMatch() {
        matches.push({ done:false, h:{name:'',sl:3,balls:0,toTotal:0}, a:{name:'',sl:3,balls:0,toTotal:0}, cur:{h:[],a:[]}, dead:[] });
        refresh();
    }

    function exportJPG() {
        html2canvas(document.getElementById('capture-area'), {backgroundColor:'#1a1a1a'}).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Scorecard.jpg';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    if(matches.length === 0) addMatch();
    refresh();
</script>
</body>
</html>