<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP TV Scorekeeper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --slate: #1a1a1a; --gold: #f1c40f; --purple: #6a0dad; --danger: #e74c3c; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: sans-serif; background: var(--slate); margin: 0; padding: 10px; color: #fff; }
        
        /* Modal Fix */
        #custom-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: #fff; color: #000; margin: 15% auto; padding: 20px; border-radius: 12px; width: 90%; text-align: center; border: 4px solid var(--purple); }
        
        .branding { text-align: center; margin-bottom: 10px; }
        .logo-box { background: white; padding: 5px 15px; border-radius: 10px; border: 2px solid var(--gold); display: inline-block; }
        .logo-mvp { color:#00FF00; font-size: 24px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 30px; font-style: italic; font-weight: 900; }
        
        .match-card { border-radius: 12px; margin-bottom: 12px; overflow: hidden; background: white; color: #333; border: 2px solid var(--gold); }
        .card-done { border-left: 10px solid var(--purple); }
        
        .head-active { background: var(--gold); color: #000; padding: 8px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        
        .ball-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin: 5px 0; }
        .ball { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #aaa; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 900; color: #fff; cursor: pointer; }
        .b1, .b9 { background: #ffea00; color: #000; } .b2 { background: #0052cc; } .b3 { background: #cc0000; } 
        .b4 { background: #4b0082; } .b5 { background: #ff8c00; } .b6 { background: #008000; } 
        .b7 { background: #8b4513; } .b8 { background: #000; } .b9 { border: 2px dashed #000; }
        
        .ball-selected { background: #fff !important; color: var(--purple) !important; border: 3px solid var(--purple) !important; transform: scale(1.1); }
        .ball-dead { background: #333 !important; opacity: 0.3; }

        .lag-btn { background: #eee; border: 1px solid #ccc; padding: 4px; border-radius: 4px; width: 100%; margin: 4px 0; font-weight: bold; cursor: pointer; }
        .lag-won { background: var(--purple) !important; color: white !important; }
        
        .to-btn { background: #fff; border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px; font-weight: 900; cursor: pointer; }
        .to-used { background: var(--danger); color: white; }
        
        input, select { padding: 6px; border-radius: 6px; border: 1px solid #ccc; width: 100%; font-weight: 900; }
        .need-box { font-weight: 900; color: var(--purple); font-size: 0.8rem; background: #f0e6ff; padding: 3px; border-radius: 4px; margin-top: 4px; }
        
        .total-score-bar { background: #000; color: var(--gold); padding: 15px; border-radius: 12px; margin-top: 10px; display: grid; grid-template-columns: 1fr auto 1fr; text-align: center; border: 2px solid var(--gold); }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-content"><h2 id="modal-title" style="margin-top:0;"></h2><p id="modal-text"></p><div id="modal-actions"></div></div>
</div>

<div class="branding"><div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div></div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
    <input id="team-h" placeholder="HOME TEAM" oninput="saveG()">
    <input id="team-a" placeholder="AWAY TEAM" oninput="saveG()">
</div>

<div id="capture-area">
    <div id="match-container"></div>
    <div class="total-score-bar">
        <div><small id="disp-h">HOME</small><div id="h-total" style="font-size:2.5rem;">0</div></div>
        <div style="padding: 0 10px; border-left: 1px solid #444; border-right: 1px solid #444; font-weight: 900; font-size: 0.7rem; align-self: center;">TOTAL<br>POINTS</div>
        <div><small id="disp-a">AWAY</small><div id="a-total" style="font-size:2.5rem;">0</div></div>
    </div>
</div>

<button onclick="addMatch()" style="width:100%; padding:15px; margin-top:10px; background:var(--gold); font-weight:900; border-radius:8px;">+ NEW MATCH</button>
<button onclick="exportJPG()" style="width:100%; padding:15px; margin-top:10px; background:#3498db; color:white; font-weight:900; border-radius:8px; border:none;">SAVE IMAGE</button>

<script>
    const races = { 1:14, 2:19, 3:25, 4:31, 5:38, 6:46, 7:55, 8:65, 9:75 };
    const chart = {
        1: [ {m:2, p:20}, {m:3, p:19}, {m:4, p:18}, {m:6, p:17}, {m:7, p:16}, {m:8, p:15}, {m:10, p:14}, {m:11, p:13}, {m:13, p:12} ],
        2: [ {m:3, p:20}, {m:5, p:19}, {m:7, p:18}, {m:8, p:17}, {m:10, p:16}, {m:12, p:15}, {m:14, p:14}, {m:16, p:13}, {m:18, p:12} ],
        3: [ {m:4, p:20}, {m:6, p:19}, {m:9, p:18}, {m:11, p:17}, {m:14, p:16}, {m:16, p:15}, {m:19, p:14}, {m:21, p:13}, {m:24, p:12} ],
        4: [ {m:5, p:20}, {m:8, p:19}, {m:11, p:18}, {m:14, p:17}, {m:18, p:16}, {m:21, p:15}, {m:24, p:14}, {m:27, p:13}, {m:30, p:12} ],
        5: [ {m:6, p:20}, {m:10, p:19}, {m:14, p:18}, {m:18, p:17}, {m:22, p:16}, {m:26, p:15}, {m:29, p:14}, {m:33, p:13}, {m:37, p:12} ],
        6: [ {m:8, p:20}, {m:12, p:19}, {m:17, p:18}, {m:22, p:17}, {m:27, p:16}, {m:31, p:15}, {m:36, p:14}, {m:40, p:13}, {m:45, p:12} ],
        7: [ {m:10, p:20}, {m:15, p:19}, {m:21, p:18}, {m:26, p:17}, {m:32, p:16}, {m:37, p:15}, {m:43, p:14}, {m:49, p:13}, {m:54, p:12} ],
        8: [ {m:13, p:20}, {m:19, p:19}, {m:26, p:18}, {m:32, p:17}, {m:39, p:16}, {m:45, p:15}, {m:52, p:14}, {m:58, p:13}, {m:64, p:12} ],
        9: [ {m:17, p:20}, {m:24, p:19}, {m:31, p:18}, {m:38, p:17}, {m:46, p:16}, {m:53, p:15}, {m:60, p:14}, {m:67, p:13}, {m:74, p:12} ]
    };

    let matches = JSON.parse(localStorage.getItem('billiard_vFinal_MVP_Fix')) || [];
    let lastT = { time: 0, b: null, s: null };

    function showM(title, text, btns) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        const d = document.getElementById('modal-actions'); d.innerHTML = '';
        btns.forEach(b => {
            const e = document.createElement('button'); e.style.padding="10px"; e.style.margin="5px";
            e.style.background = b.color || '#333'; e.style.color="white"; e.innerText = b.text;
            e.onclick = () => { document.getElementById('custom-modal').style.display='none'; b.f(); };
            d.appendChild(e);
        });
        document.getElementById('custom-modal').style.display = 'block';
    }

    function saveG() {
        localStorage.setItem('team_h', document.getElementById('team-h').value);
        localStorage.setItem('team_a', document.getElementById('team-a').value);
        document.getElementById('disp-h').innerText = document.getElementById('team-h').value || "HOME";
        document.getElementById('disp-a').innerText = document.getElementById('team-a').value || "AWAY";
    }

    function refresh() {
        localStorage.setItem('billiard_vFinal_MVP_Fix', JSON.stringify(matches));
        const c = document.getElementById('match-container'); c.innerHTML = '';
        let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            const hPt = getPts('h', i); const aPt = getPts('a', i);
            tH += hPt; tA += aPt;
            const card = document.createElement('div');
            card.className = `match-card ${m.done ? 'card-done' : ''}`;
            
            if (m.done) {
                card.innerHTML = `<div style="background:#222;color:#fff;padding:8px;font-weight:900;display:flex;justify-content:space-between;">
                    <span>MATCH ${i+1} FINAL | ${hPt}-${aPt}</span>
                    <button onclick="editM(${i})" style="font-size:0.6rem;">EDIT</button>
                </div>
                <div style="padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:0.8rem;">
                    <div><b>${m.h.n} (SL${m.h.sl})</b><br>Lag: ${m.lag==='h'?'WON':'—'}<br>Balls: ${m.h.b}/${races[m.h.sl]}<br>Def/TO: ${m.h.d}/${m.h.toTotal}</div>
                    <div><b>${m.a.n} (SL${m.a.sl})</b><br>Lag: ${m.lag==='a'?'WON':'—'}<br>Balls: ${m.a.b}/${races[m.a.sl]}<br>Def/TO: ${m.a.d}/${m.a.toTotal}</div>
                </div>`;
            } else {
                card.innerHTML = `<div class="head-active"><span>MATCH ${i+1}</span>
                    <button onclick="finM(${i})" style="background:black;color:white;border:none;padding:4px 8px;font-size:0.7rem;font-weight:900;border-radius:4px;">FINISH</button>
                </div>
                <div style="padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="text-align:center;">
                        <input value="${m.h.n}" placeholder="Name" oninput="matches[${i}].h.n=this.value; localStorage.setItem('billiard_vFinal_MVP_Fix', JSON.stringify(matches))">
                        <button class="lag-btn ${m.lag==='h'?'lag-won':''}" onclick="matches[${i}].lag='h'; refresh()">LAG WINNER</button>
                        <select onchange="matches[${i}].h.sl=parseInt(this.value); refresh()">${Object.keys(races).map(s=>`<option value="${s}" ${m.h.sl==s?'selected':''}>SL ${s}</option>`)}</select>
                        <div style="margin:4px 0;">${renderTO(i,'h')}</div>
                        <div class="ball-container">${renderB(i,'h')}</div>
                        <div style="font-size:0.7rem;">DEF: <b>${m.h.d}</b> <button onclick="adj(${i},'h','d',1)">+</button> <button onclick="adj(${i},'h','d',-1)">-</button></div>
                        <div class="need-box">NEED: ${Math.max(0, races[m.h.sl] - m.h.b)}</div>
                    </div>
                    <div style="text-align:center;">
                        <input value="${m.a.n}" placeholder="Name" oninput="matches[${i}].a.n=this.value; localStorage.setItem('billiard_vFinal_MVP_Fix', JSON.stringify(matches))">
                        <button class="lag-btn ${m.lag==='a'?'lag-won':''}" onclick="matches[${i}].lag='a'; refresh()">LAG WINNER</button>
                        <select onchange="matches[${i}].a.sl=parseInt(        .to-btn { background: #fff; border: 2px solid #ddd; padding: 4px 8px; font-size: 0.