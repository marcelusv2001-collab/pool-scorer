<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>9-Ball Rack Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --felt: #f1c40f; --slate: #1a1a1a; --gold: #f1c40f; --chalk: #3498db; --danger: #e74c3c;
            --ball-1: #f1c40f; --ball-2: #2980b9; --ball-3: #e74c3c; --ball-4: #8e44ad; 
            --ball-5: #e67e22; --ball-6: #27ae60; --ball-7: #964b00; --ball-8: #2c3e50; --ball-9: #f1c40f;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--slate); 
            background-image: radial-gradient(circle, #444 0%, #1a1a1a 100%);
            margin: 0; padding: 8px; color: #fff;
        }
        .branding { text-align: center; margin-bottom: 12px; }
        .logo-box { background: white; padding: 8px 15px; display: inline-block; border-radius: 12px; }
        .logo-mvp { color:#00FF00; font-size: 26px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 34px; font-style: italic; font-weight: 900; font-family: 'Brush Script MT', cursive; margin-left: -5px; }
        
        .sheet { background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 5px; }
        .match-card { background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; color: #333; border-left: 6px solid var(--felt); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .head-active { background: var(--felt); color: #000; padding: 8px 12px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        
        .grid-main { display: grid; grid-template-columns: 1fr 1fr; padding: 8px; gap: 8px; }
        .name-input { font-weight: 800; border: none; border-bottom: 2px solid #eee; width: 100%; font-size: 0.85rem; margin-bottom: 10px; }

        /* Ball Selector Styles */
        .ball-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 5px; }
        .ball { 
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid #ddd; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.7rem; font-weight: 900; color: #fff; cursor: pointer; text-shadow: 1px 1px 1px #000;
        }
        .ball-selected { border: 2px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.5); transform: scale(1.1); }
        .b1 { background: #ffea00; color: #000; text-shadow: none; } .b2 { background: #0052cc; } .b3 { background: #cc0000; }
        .b4 { background: #4b0082; } .b5 { background: #ff8c00; } .b6 { background: #008000; }
        .b7 { background: #8b4513; } .b8 { background: #000; } .b9 { background: #ffea00; color: #000; border: 2px dashed #000; text-shadow: none; }
        .b-dead { background: #777; border: 1px solid #333; }

        .rack-log { 
            background: #eee; padding: 8px; font-size: 0.7rem; font-weight: 800; 
            border-top: 1px solid #ccc; max-height: 60px; overflow-y: auto;
        }
        
        .total-score-bar { 
            background: #000; color: var(--gold); padding: 10px; border-radius: 10px; 
            margin: 10px 0; display: grid; grid-template-columns: 1fr auto 1fr; 
            align-items: center; text-align: center; border: 1px solid var(--gold); 
        }
        .total-val { font-size: 1.4rem; font-weight: 900; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .action-btn { padding: 12px; border: none; border-radius: 10px; font-weight: 800; color: white; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
</div>

<div id="capture-area" class="sheet">
    <div id="match-container"></div>
</div>

<div class="total-score-bar">
    <div><div class="total-val" id="h-total">0</div></div>
    <div style="font-weight: 900; font-size: 0.8rem;">TOTAL BALLS</div>
    <div><div class="total-val" id="a-total">0</div></div>
</div>

<div class="actions">
    <button class="action-btn" style="background: var(--felt); color:#000; grid-column: span 2;" onclick="addMatch()">+ New 9-Ball Match</button>
    <button class="action-btn" style="background: var(--chalk);" onclick="exportJPG()">Save JPG</button>
    <button class="action-btn" style="background: var(--danger);" onclick="resetAll()">Reset All</button>
</div>

<script>
    let matches = JSON.parse(localStorage.getItem('mvp_9ball_balls')) || [];

    function refresh() {
        localStorage.setItem('mvp_9ball_balls', JSON.stringify(matches));
        const container = document.getElementById('match-container');
        container.innerHTML = '';
        let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            tH += m.hTotal; tA += m.aTotal;
            const card = document.createElement('div');
            card.className = 'match-card';
            card.innerHTML = `
                <div class="head-active">MATCH ${i+1} | RACK ${m.racks.length + 1}</div>
                <div class="grid-main">
                    <div>
                        <input type="text" class="name-input" placeholder="Home" value="${m.hName}" oninput="matches[${i}].hName=this.value">
                        <div class="ball-container">${renderBalls(i, 'h')}</div>
                    </div>
                    <div>
                        <input type="text" class="name-input" placeholder="Away" value="${m.aName}" oninput="matches[${i}].aName=this.value">
                        <div class="ball-container">${renderBalls(i, 'a')}</div>
                    </div>
                </div>
                <div style="text-align:center; padding: 5px; background:#ddd;">
                    Dead Balls: <button onclick="adjDB(${i},-1)">-</button> <b>${m.currentRack.db}</b> <button onclick="adjDB(${i},1)">+</button>
                </div>
                <div class="rack-log">LOG: ${m.racks.join(' | ') || 'No racks yet'}</div>
            `;
            container.appendChild(card);
        });
        document.getElementById('h-total').innerText = tH;
        document.getElementById('a-total').innerText = tA;
    }

    function renderBalls(mIdx, side) {
        let html = '';
        for(let n=1; n<=9; n++) {
            const isSel = matches[mIdx].currentRack[side].includes(n);
            html += `<div class="ball b${n} ${isSel?'ball-selected':''}" onclick="toggleBall(${mIdx},'${side}',${n})">${n}</div>`;
        }
        return html;
    }

    function toggleBall(mIdx, side, num) {
        const m = matches[mIdx];
        const oppSide = side === 'h' ? 'a' : 'h';
        
        // Remove from opponent if they had it
        m.currentRack[oppSide] = m.currentRack[oppSide].filter(n => n !== num);
        
        // Toggle for current player
        if (m.currentRack[side].includes(num)) {
            m.currentRack[side] = m.currentRack[side].filter(n => n !== num);
        } else {
            m.currentRack[side].push(num);
        }

        checkRack(mIdx);
        refresh();
    }

    function adjDB(mIdx, v) {
        matches[mIdx].currentRack.db = Math.max(0, matches[mIdx].currentRack.db + v);
        checkRack(mIdx);
        refresh();
    }

    function checkRack(mIdx) {
        const m = matches[mIdx];
        const hBalls = m.currentRack.h.length + (m.currentRack.h.includes(9) ? 1 : 0);
        const aBalls = m.currentRack.a.length + (m.currentRack.a.includes(9) ? 1 : 0);
        const total = m.currentRack.h.length + m.currentRack.a.length + m.currentRack.db;

        // In 9-ball, 1-8 are 1pt, 9 is 2pts. Total points per rack = 10.
        if (total >= 9) {
            const hPts = m.currentRack.h.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
            const aPts = m.currentRack.a.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
            
            m.racks.push(`R${m.racks.length+1}: ${hPts}-${aPts}${m.currentRack.db > 0 ? ' +'+m.currentRack.db+'DB' : ''}`);
            m.hTotal += hPts;
            m.aTotal += aPts;
            
            // Reset for next rack
            m.currentRack = { h: [], a: [], db: 0 };
        }
    }

    function addMatch() {
        matches.push({
            hName: '', aName: '', hTotal: 0, aTotal: 0,
            racks: [], currentRack: { h: [], a: [], db: 0 }
        });
        refresh();
    }

    function resetAll() { if(confirm("Clear all?")) { matches = []; localStorage.clear(); addMatch(); } }
    function exportJPG(){ html2canvas(document.getElementById('capture-area')).then(c=>{const l=document.createElement('a'); l.download='9ball.jpg'; l.href=c.toDataURL(); l.click();});}

    if(matches.length === 0) addMatch();
    refresh();
</script>
</body>
</html>