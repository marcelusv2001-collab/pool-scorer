<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP TV Scorekeeper PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --slate: #1a1a1a; --gold: #f1c40f; --purple: #6a0dad; --danger: #e74c3c; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--slate); margin: 0; padding: 10px; color: #fff; }
        
        #custom-modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: #fff; color: #000; margin: 15% auto; padding: 25px; border-radius: 15px; width: 85%; text-align: center; border: 5px solid var(--purple); }
        .modal-btn { padding: 12px 15px; margin: 5px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; color: white; min-width: 80px; }

        .branding { text-align: center; margin-bottom: 20px; }
        .logo-box { background: white; padding: 8px 20px; border-radius: 12px; border: 3px solid var(--gold); display: inline-block; }
        .logo-mvp { color:#00FF00; font-size: 26px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 34px; font-style: italic; font-weight: 900; margin-left: -5px; }
        .sub-logo { display: block; color: white; font-size: 0.9rem; font-weight: 300; letter-spacing: 1px; margin-top: 5px; opacity: 0.9; }
        
        .match-card { border-radius: 15px; margin-bottom: 15px; overflow: hidden; color: #333; background: white; border: 2px solid var(--gold); }
        .card-done { border-left: 12px solid var(--purple); opacity: 0.98; }
        .head-active { background: var(--gold); color: #000; padding: 10px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        
        .ball-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin: 8px 0; }
        .ball { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #aaa; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 900; color: #fff; cursor: pointer; }
        .b1, .b9 { background: #ffea00; color: #000; } .b2 { background: #0052cc; } .b3 { background: #cc0000; } 
        .b4 { background: #4b0082; } .b5 { background: #ff8c00; } .b6 { background: #008000; } 
        .b7 { background: #8b4513; } .b8 { background: #000; } .b9 { border: 2px dashed #000; }

        .ball-selected { background: #ffffff !important; color: var(--purple) !important; border: 3px solid var(--purple) !important; transform: scale(1.1); }
        .ball-dead { background: #333 !important; opacity: 0.4; border: 2px solid red !important; }
        
        .lag-btn { background: #eee; border: 1px solid #ccc; font-size: 0.65rem; padding: 5px; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 5px; font-weight: 900; }
        .lag-won { background: var(--purple) !important; color: white !important; }
        
        .to-btn { background: #fff; border: 2px solid #ddd; padding: 4px 8px; font-size: 0.7rem; border-radius: 6px; font-weight: 900; cursor: pointer; }
        .to-used { background: var(--danger); color: white; border-color: var(--danger); }
        
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-bottom: 4px; font-weight: 900; }
        .need-val { font-weight: 900; color: var(--purple); font-size: 0.8rem; background: #f0e6ff; padding: 3px; border-radius: 4px; margin-top: 5px; }
        
        .total-score-bar { background: #000; color: var(--gold); padding: 20px; border-radius: 15px; margin: 15px 0; display: grid; grid-template-columns: 1fr auto 1fr; text-align: center; border: 3px solid var(--gold); }
        
        /* New Button Grid Styling */
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .action-btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: 900; color: white; cursor: pointer; font-size: 0.9rem; }
        .long-btn { grid-column: span 2; margin-top: 10px; }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-content"><h2 id="modal-title"></h2><p id="modal-text"></p><div id="modal-actions"></div></div>
</div>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
    <span class="sub-logo">Billiard Offline Scorekeeper</span>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
    <input id="team-h" placeholder="HOME TEAM" oninput="saveG()">
    <input id="team-a" placeholder="AWAY TEAM" oninput="saveG()">
</div>

<div id="capture-area">
    <div id="match-container"></div>
    <div class="total-score-bar">
        <div><small id="disp-h">HOME</small><div id="h-total" style="font-size:3rem;">0</div></div>
        <div style="padding: 0 15px; border-left: 2px solid #333; border-right: 2px solid #333; display: flex; align-items: center; font-weight: 900; font-size:0.7rem;">TOTAL<br>POINTS</div>
        <div><small id="disp-a">AWAY</small><div id="a-total" style="font-size:3rem;">0</div></div>
    </div>
</div>

<div class="button-grid">
    <button class="action-btn" style="background:var(--gold); color:#000;" onclick="addMatch()">+ New Match</button>
    <button class="action-btn" style="background:#3498db;" onclick="exportJPG()">Save Image</button>
    <button class="action-btn" style="background:#2ecc71;" onclick="copyClipboard()">Copy Clipboard</button>
    <button class="action-btn" style="background:#27ae60;" onclick="exportTXT()">Export TXT</button>
    <button class="action-btn long-btn" style="background:var(--danger);" onclick="resetAll()">RESET ALL MATCHES</button>
</div>

<script>
    const races = { 1:14, 2:19, 3:25, 4:31, 5:38, 6:46, 7:55, 8:65, 9:75 };
    const scoreChart = {
        1: [2, 3, 4, 6, 7, 8, 10, 11, 13], 2: [3, 5, 7, 8, 10, 12, 14, 16, 18],
        3: [4, 6, 9, 11, 14, 16, 19, 21, 24], 4: [5, 8, 11, 14, 18, 21, 24, 27, 30],
        5: [6, 10, 14, 18, 22, 26, 29, 33, 37], 6: [8, 12, 17, 22, 27, 31, 36, 40, 45],
        7: [10, 15, 21, 26, 32, 37, 43, 49, 54], 8: [13, 19, 26, 32, 39, 45, 52, 58, 64],
        9: [17, 24, 31, 38, 46, 53, 60, 67, 74]
    };

    let matches = JSON.parse(localStorage.getItem('billiard_vFinal_MVP_vFix')) || [];
    let lastT = { time: 0, b: null, s: null };

    function showM(title, text, btns) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        const d = document.getElementById('modal-actions'); d.innerHTML = '';
        btns.forEach(b => {
            const e = document.createElement('button'); e.className = 'modal-btn';
            e.style.background = b.color || '#333'; e.innerText = b.text;
            e.onclick = () => { document.getElementById('custom-modal').style.display='none'; b.f(); };
            d.appendChild(e);
        });
        document.getElementById('custom-modal').style.display = 'block';
    }

    function saveG() {
        const h = document.getElementById('team-h').value;
        const a = document.getElementById('team-a').value;
        localStorage.setItem('team_h', h);
        localStorage.setItem('team_a', a);
        document.getElementById('disp-h').innerText = h || "HOME";
        document.getElementById('disp-a').innerText = a || "AWAY";
    }

    function updatePlayerName(idx, side, name) {
        matches[idx][side].n = name;
        localStorage.setItem('billiard_vFinal_MVP_vFix', JSON.stringify(matches));
    }

    function calculateSplit(idx) {
        const m = matches[idx];
        const h = m.h; const a = m.a;
        const hWin = h.b >= races[h.sl];
        const aWin = a.b >= races[a.sl];
        if (!hWin && !aWin) return { h: 0, a: 0 };
        const loser = hWin ? a : h;
        const thresholds = scoreChart[loser.sl];
        let loserScore = 0;
        for (let i = thresholds.length - 1; i >= 0; i--) {
            if (loser.b > thresholds[i]) { loserScore = i + 1; break; }
        }
        const winnerScore = 20 - loserScore;
        return hWin ? { h: winnerScore, a: loserScore } : { h: loserScore, a: winnerScore };
    }

    function refresh() {
        localStorage.setItem('billiard_vFinal_MVP_vFix', JSON.stringify(matches));
        const container = document.getElementById('match-container');
        container.innerHTML = ''; let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            const scores = calculateSplit(i);
            tH += scores.h; tA += scores.a;
            const card = document.createElement('div');
            card.className = `match-card ${m.done ? 'card-done' : ''}`;
            
            if (m.done) {
                card.innerHTML = `<div style="background:#222;color:#fff;padding:12px;font-weight:900;display:flex;justify-content:space-between;align-items:center;">
                    <span>M${i+1} | ${scores.h}-${scores.a}</span>
                    <div><button onclick="resetM(${i})" style="background:red;color:white;padding:4px 8px;border-radius:4px;margin-right:5px;border:none;font-size:0.7rem;">RESET</button><button onclick="editM(${i})" style="font-size:0.7rem;">EDIT</button></div>
                </div>
                <div style="padding:15px;display:grid;grid-template-columns:1fr 1fr;gap:20px;background:white;position:relative;color:#333;">
                    <div style="position:absolute; top:5px; left:50%; transform:translateX(-50%); font-weight:900; color:var(--purple); font-size:0.7rem;">INN: ${m.inn} | DB: ${m.deadTotal}</div>
                    <div><b>${m.h.n||'Player'}</b> (SL${m.h.sl})<br>Balls: ${m.h.b}/${races[m.h.sl]}<br>TOs: ${m.h.toTotal} | DEF: ${m.h.d}</div>
                    <div><b>${m.a.n||'Player'}</b> (SL${m.a.sl})<br>Balls: ${m.a.b}/${races[m.a.sl]}<br>TOs: ${m.a.toTotal} | DEF: ${m.a.d}</div>
                </div>`;
            } else {
                card.innerHTML = `<div class="head-active"><span>M${i+1}</span>
                    <div><span style="margin-right:10px;">INN: <button onclick="adj(${i},null,'inn',-1)">-</button> <b>${m.inn}</b> <button onclick="adj(${i},null,'inn',1)">+</button></span>
                    <span style="margin-right:15px; font-size:0.8rem; color:#000;">DB: <b>${m.deadTotal + m.dead.length}</b></span>
                    <button onclick="resetM(${i})" style="background:red;color:white;border:none;padding:4px 8px;font-size:0.7rem;margin-right:5px;">RESET</button>
                    <button onclick="finM(${i})" style="background:black;color:white;border:none;padding:4px 8px;font-size:0.7rem;">FINISH</button></div>
                </div>
                <div style="padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div style="text-align:center;"><input value="${m.h.n}" oninput="updatePlayerName(${i},'h',this.value)" placeholder="Home Player">
                        <button class="lag-btn ${m.lag==='h'?'lag-won':''}" onclick="setLag(${i},'h')">LAG WIN</button>
                        <select onchange="setSL(${i},'h',this.value)">${Object.keys(races).map(s=>`<option value="${s}" ${m.h.sl==s?'selected':''}>SL ${s}</option>`)}</select>
                        <div style="margin:5px 0;">${renderTO(i,'h')}</div><div class="ball-container">${renderB(i,'h')}</div>
                        <div style="font-size:0.7rem;color:#333;">DEF: <b>${m.h.d}</b> <button onclick="adj(${i},'h','d',1)">+</button> <button onclick="adj(${i},'h','d',-1)">-</button></div>
                        <div class="need-val">NEED: ${Math.max(0, races[m.h.sl] - m.h.b)}</div>
                    </div>
                    <div style="text-align:center;"><input value="${m.a.n}" oninput="updatePlayerName(${i},'a',this.value)" placeholder="Away Player">
                        <button class="lag-btn ${m.lag==='a'?'lag-won':''}" onclick="setLag(${i},'a')">LAG WIN</button>
                        <select onchange="setSL(${i},'a',this.value)">${Object.keys(races).map(s=>`<option value="${s}" ${m.a.sl==s?'selected':''}>SL ${s}</option>`)}</select>
                        <div style="margin:5px 0;">${renderTO(i,'a')}</div><div class="ball-container">${renderB(i,'a')}</div>
                        <div style="font-size:0.7rem;color:#333;">DEF: <b>${m.a.d}</b> <button onclick="adj(${i},'a','d',1)">+</button> <button onclick="adj(${i},'a','d',-1)">-</button></div>
                        <div class="need-val">NEED: ${Math.max(0, races[m.a.sl] - m.a.b)}</div>
                    </div>
                </div>`;
            }
            container.appendChild(card);
        });
        document.getElementById('h-total').innerText = tH; document.getElementById('a-total').innerText = tA;
    }

    function setLag(i, s) { matches[i].lag = s; refresh(); }
    function setSL(i, s, v) { matches[i][s].sl = parseInt(v); refresh(); }
    function adj(i, s, k, v) { if(s) matches[i][s][k] = Math.max(0, matches[i][s][k] + v); else matches[i][k] = Math.max(0, matches[i][k] + v); refresh(); }

    function renderTO(idx, side) {
        const m = matches[idx][side]; const limit = m.sl <= 3 ? 2 : 1; let h = '';
        for(let j=1; j<=limit; j++) { h += `<button class="to-btn ${m.toCur>=j?'to-used':''}" onclick="useTO(${idx},'${side}',${j})">TO</button> `; }
        return h + `<div style="font-size:0.6rem; margin-top:2px; color:#333;">TO Total: ${m.toTotal}</div>`;
    }

    function useTO(idx, side, n) {
        const m = matches[idx][side]; if (m.toCur === n) m.toCur--; else { m.toCur = n; m.toTotal++; } refresh();
    }

    function renderB(idx, side) {
        let h = '';
        for(let n=1; n<=9; n++) {
            const isS = matches[idx].cur[side].includes(n); const isD = matches[idx].dead.includes(n);
            let cls = isS ? 'ball-selected' : (isD ? 'ball-dead' : `b${n}`);
            h += `<div class="ball ${cls}" onclick="hBall(${idx},'${side}',${n})">${n}</div>`;
        }
        return h;
    }

    function hBall(idx, side, n) {
        const now = Date.now(); const m = matches[idx];
        if (now - lastT.time < 350 && lastT.b === n && lastT.s === side) {
            m.cur.h = m.cur.h.filter(x => x !== n); m.cur.a = m.cur.a.filter(x => x !== n);
            if (!m.dead.includes(n)) m.dead.push(n); refresh(); return;
        }
        lastT = { time: now, b: n, s: side };
        const opp = side === 'h' ? 'a' : 'h'; m.dead = m.dead.filter(x => x !== n); m.cur[opp] = m.cur[opp].filter(x => x !== n);
        if (m.cur[side].includes(n)) m.cur[side] = m.cur[side].filter(x => x !== n); else m.cur[side].push(n);
        if (n === 9 && m.cur[side].includes(9)) {
            showM("END RACK", "9-Ball Pocketed", [
                { text: "SNAP", color: "#2ecc71", f: () => eRack(idx) },
                { text: "B&R", color: "#3498db", f: () => eRack(idx) },
                { text: "REGULAR", color: "#f1c40f", f: () => eRack(idx) },
                { text: "CANCEL", f: () => { m.cur[side] = m.cur[side].filter(x => x !== 9); refresh(); } }
            ]);
        }
        refresh();
    }

    function eRack(idx) {
        const m = matches[idx];
        for(let i=1; i<=8; i++) { if(!m.cur.h.includes(i) && !m.cur.a.includes(i) && !m.dead.includes(i)) m.dead.push(i); }
        m.h.b = Math.min(races[m.h.sl], m.h.b + m.cur.h.reduce((a, n) => a + (n === 9 ? 2 : 1), 0));
        m.a.b = Math.min(races[m.a.sl], m.a.b + m.cur.a.reduce((a, n) => a + (n === 9 ? 2 : 1), 0));
        m.deadTotal += m.dead.length;
        m.cur = { h: [], a: [] }; m.dead = []; m.h.toCur = 0; m.a.toCur = 0; 
        if(m.h.b >= races[m.h.sl] || m.a.b >= races[m.a.sl]) {
            const s = calculateSplit(idx);
            showM("MATCH OVER!", `Split: ${s.h}-${s.a}`, [{ text: "FINISH", color: "var(--purple)", f: () => { m.done = true; refresh(); } }, { text: "CANCEL", f: () => refresh() }]);
        }
        refresh();
    }

    function resetM(i) {
        showM("RESET MATCH", "Wipe M" + (i+1) + "?", [{ text: "WIPE", color: "red", f: () => { 
            matches[i] = { done:false, lag:null, dead:[], deadTotal:0, inn:0, h:{n:'',sl:3,b:0,d:0,toCur:0,toTotal:0}, a:{n:'',sl:3,b:0,d:0,toCur:0,toTotal:0},_cur:{h:[],a:[]} }; 
            refresh(); 
        } }, { text: "CANCEL", f: () => {} }]);
    }

    function resetAll() {
        showM("RESET ALL", "Wipe EVERYTHING?", [{ text: "WIPE", color: "red", f: () => { matches = []; addMatch(); refresh(); } }, { text: "CANCEL", f: () => {} }]);
    }

    function buildSummaryText() {
        let txt = `ðŸ† MVP TV BILLIARDS\n${document.getElementById('team-h').value} vs ${document.getElementById('team-a').value}\n==========================\n`;
        matches.forEach((m, i) => {
            const s = calculateSplit(i);
            txt += `M${i+1}: ${m.h.n||'H'} vs ${m.a.n||'A'}\nSCORE: ${s.h}-${s.a} | INN: ${m.inn} | DEF: ${m.h.d}/${m.a.d} | TO: ${m.h.toTotal}/${m.a.toTotal}\n--------------------------\n`;
        });
        txt += `TOTAL: ${document.getElementById('h-total').innerText} - ${document.getElementById('a-total').innerText}`;
        return txt;
    }

    function copyClipboard() { navigator.clipboard.writeText(buildSummaryText()).then(() => alert("Copied!")); }
    function exportTXT() {
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([buildSummaryText()], {type: "text/plain"}));
        a.download = "MVP_Score.txt"; a.click();
    }

    function finM(i) { showM("FINISH", "Finalize?", [{ text: "YES", color: "#6a0dad", f: () => { matches[i].done=true; refresh(); } }, { text: "NO", f: () => {} }]); }
    function editM(i) { matches[i].done = false; refresh(); }
    function addMatch() {
        if(matches.length < 5) {
            matches.push({ done:false, lag:null, dead:[], deadTotal:0, inn:0, h:{n:'',sl:3,b:0,d:0,toCur:0,toTotal:0}, a:{n:'',sl:3,b:0,d:0,toCur:0,toTotal:0}, cur:{h:[],a:[]} });
            refresh();
        }
    }

    function exportJPG() {
        html2canvas(document.getElementById('capture-area'), {backgroundColor:'#1a1a1a', scale: 2}).then(c => {
            const l = document.createElement('a'); l.download = 'MVP_Score.jpg'; l.href = c.toDataURL(); l.click();
        });
    }

    document.getElementById('team-h').value = localStorage.getItem('team_h') || "";
    document.getElementById('team-a').value = localStorage.getItem('team_a') || "";
    saveG(); if(matches.length === 0) addMatch(); refresh();
</script>
</body>
</html>