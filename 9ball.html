<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP 9-Ball Tracker v5.0 Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --felt: #f1c40f; --slate: #1a1a1a; --gold: #f1c40f; --chalk: #3498db; --danger: #e74c3c;
            --active-bg: #ffffff; --done-bg: #f9f9f9;
        }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--slate); margin: 0; padding: 10px; color: #fff; }
        
        .branding { text-align: center; margin-bottom: 15px; }
        .logo-box { background: white; padding: 10px 20px; border-radius: 15px; border: 3px solid var(--gold); display: inline-block; }
        .logo-mvp { color:#00FF00; font-size: 28px; font-weight: 900; }
        .logo-tv { color:#FF0000; font-size: 38px; font-style: italic; font-weight: 900; font-family: 'Brush Script MT', cursive; margin-left: -5px; }
        
        .match-card { border-radius: 15px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8); color: #333; }
        .card-active { background: var(--active-bg); border: 2px solid var(--felt); }
        .card-done { background: var(--done-bg); border-left: 12px solid #333; opacity: 0.9; }
        
        .head-active { background: var(--felt); color: #000; padding: 12px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .head-done { background: #222; color: #fff; padding: 10px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        
        .ball-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 12px 0; }
        .ball { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #aaa; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 900; color: #fff; cursor: pointer; text-shadow: 1px 1px 1px #000; box-shadow: inset -3px -3px 6px rgba(0,0,0,0.5); }
        .ball-selected { border: 4px solid #000; transform: scale(1.15); z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        
        .b1,.b9{background:#ffea00; color:#000; text-shadow:none} .b9{border:2px dashed #000}
        .b2{background:#0052cc} .b3{background:#cc0000} .b4{background:#4b0082} .b5{background:#ff8c00} .b6{background:#008000} .b7{background:#8b4513} .b8{background:#000}

        input, select { font-weight: 700; border: 1px solid #ccc; border-radius: 8px; padding: 12px; width: 100%; margin-bottom: 10px; font-size: 1rem; background: white; }
        .stat-box { background: #eee; border-radius: 10px; padding: 12px; text-align: center; font-size: 1rem; font-weight: 900; border: 1px solid #ddd; }
        
        .total-score-bar { background: #000; color: var(--gold); padding: 20px; border-radius: 15px; margin: 15px 0; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; text-align: center; border: 2px solid var(--gold); }
        .action-btn { width: 100%; padding: 20px; border: none; border-radius: 15px; font-weight: 900; color: white; cursor: pointer; text-transform: uppercase; font-size: 1.1rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="branding">
    <div class="logo-box"><span class="logo-mvp">MVP</span><span class="logo-tv">TV</span></div>
</div>

<div id="capture-area" style="padding:5px;">
    <div id="match-container"></div>

    <div class="total-score-bar">
        <div><small>HOME TEAM</small><div id="h-total" style="font-size:2.8rem;font-weight:900;">0</div></div>
        <div style="font-size:0.8rem; font-weight:900; padding: 0 25px; border-left: 2px solid #333; border-right: 2px solid #333;">MATCH<br>POINTS</div>
        <div><small>AWAY TEAM</small><div id="a-total" style="font-size:2.8rem;font-weight:900;">0</div></div>
    </div>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom: 80px;">
    <button class="action-btn" style="background:var(--felt); color:#000; grid-column: span 2;" onclick="addMatch()">+ New Match</button>
    <button class="action-btn" style="background:var(--chalk);" onclick="exportJPG()">Export Scorecard</button>
    <button class="action-btn" style="background:var(--danger);" onclick="resetAll()">Reset App</button>
</div>

<script>
    const raceReq = { 1:14, 2:19, 3:25, 4:31, 5:38, 6:46, 7:55, 8:65, 9:75 };
    const STORE_KEY = 'mvp_9ball_v5_final_certified';
    let matches = JSON.parse(localStorage.getItem(STORE_KEY)) || [];

    function refresh() {
        localStorage.setItem(STORE_KEY, JSON.stringify(matches));
        const container = document.getElementById('match-container');
        container.innerHTML = '';
        let tH = 0, tA = 0;

        matches.forEach((m, i) => {
            const hR = raceReq[m.h.sl], aR = raceReq[m.a.sl];
            const hPts = calc9Pts(m.h.balls, hR, m.a.balls, aR);
            const aPts = calc9Pts(m.a.balls, aR, m.h.balls, hR);
            tH += hPts; tA += aPts;

            const card = document.createElement('div');
            card.className = `match-card ${m.done ? 'card-done' : 'card-active'}`;
            
            if (m.done) {
                card.innerHTML = `
                    <div class="head-done">MATCH ${i+1} FINAL | ${hPts} - ${aPts} <button onclick="toggleEdit(${i})" style="margin-left:auto; padding:5px 12px; font-size:0.8rem; border-radius:5px;">RE-OPEN</button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; padding:25px; text-align:center;">
                        <div><small>HOME</small><br><b style="font-size:1.3rem;">${m.h.name || 'Player'}</b><br><span style="font-size:1.8rem;">${m.h.balls}</span>/${hR}</div>
                        <div><small>AWAY</small><br><b style="font-size:1.3rem;">${m.a.name || 'Player'}</b><br><span style="font-size:1.8rem;">${m.a.balls}</span>/${aR}</div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="head-active">M${i+1} LIVE | RACE ${hR}-${aR} <button onclick="finish(${i})" style="font-weight:900; background:#000; color:#fff; border:none; padding:10px 20px; border-radius:8px;">FINISH</button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; padding:15px; gap:20px;">
                        <div style="text-align:center;">
                            <input placeholder="Home Name" value="${m.h.name}" oninput="matches[${i}].h.name=this.value">
                            <select onchange="matches[${i}].h.sl=this.value; refresh()">${Object.keys(raceReq).map(n=>`<option value="${n}" ${m.h.sl==n?'selected':''}>SL ${n} (Race ${raceReq[n]})</option>`)}</select>
                            <div class="ball-container">${renderBalls(i, 'h')}</div>
                            <div class="stat-box">TOTAL: ${m.h.balls}</div>
                        </div>
                        <div style="text-align:center;">
                            <input placeholder="Away Name" value="${m.a.name}" oninput="matches[${i}].a.name=this.value">
                            <select onchange="matches[${i}].a.sl=this.value; refresh()">${Object.keys(raceReq).map(n=>`<option value="${n}" ${m.a.sl==n?'selected':''}>SL ${n} (Race ${raceReq[n]})</option>`)}</select>
                            <div class="ball-container">${renderBalls(i, 'a')}</div>
                            <div class="stat-box">TOTAL: ${m.a.balls}</div>
                        </div>
                    </div>
                    <div style="background:#f0f0f0; padding:15px; text-align:center; color:#333; font-weight:900; border-top:1px solid #ddd;">
                        DEAD BALLS: <button onclick="adjDB(${i},-1)" style="padding:10px 25px; border-radius:10px;">-</button> 
                        <span style="font-size:2rem; margin:0 30px; vertical-align:middle;">${m.dbCur}</span> 
                        <button onclick="adjDB(${i},1)" style="padding:10px 25px; border-radius:10px;">+</button>
                    </div>`;
            }
            container.appendChild(card);
        });
        document.getElementById('h-total').innerText = tH;
        document.getElementById('a-total').innerText = tA;
    }

    function renderBalls(mIdx, side) {
        let h = '';
        for(let n=1; n<=9; n++) {
            const sel = matches[mIdx].cur[side].includes(n);
            h += `<div class="ball b${n} ${sel?'ball-selected':''}" onclick="tapBall(${mIdx},'${side}',${n})">${n}</div>`;
        }
        return h;
    }

    function tapBall(mIdx, side, num) {
        const m = matches[mIdx], opp = side === 'h' ? 'a' : 'h';
        m.cur[opp] = m.cur[opp].filter(n => n !== num);
        if (m.cur[side].includes(num)) m.cur[side] = m.cur[side].filter(n => n !== num);
        else m.cur[side].push(num);
        
        const hp = m.cur.h.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
        const ap = m.cur.a.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);

        if (num === 9 || (hp + ap + m.dbCur) >= 10) {
            setTimeout(() => { if(confirm("End current rack?")) recordRack(mIdx); refresh(); }, 30);
        }
        refresh();
    }

    function recordRack(mIdx) {
        const m = matches[mIdx];
        const hAdd = m.cur.h.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
        const aAdd = m.cur.a.reduce((acc, n) => acc + (n === 9 ? 2 : 1), 0);
        m.h.balls = Math.min(raceReq[m.h.sl], m.h.balls + hAdd);
        m.a.balls = Math.min(raceReq[m.a.sl], m.a.balls + aAdd);
        m.dbCur = 0; m.cur = { h: [], a: [] };
    }

    function calc9Pts(p, t, op, ot) {
        if (p >= t) return 20;
        if (op >= ot) {
            const pct = (p / t) * 100;
            if (pct >= 90) return 8; if (pct >= 80) return 7; if (pct >= 70) return 6;
            if (pct >= 60) return 5; if (pct >= 50) return 4; if (pct >= 40) return 3;
            if (pct >= 30) return 2; if (pct >= 20) return 1;
        }
        return 0;
    }

    function adjDB(i, v) { matches[i].dbCur = Math.max(0, matches[i].dbCur + v); refresh(); }
    function finish(i) { if(confirm("Confirm: Mark as Final?")) { matches[i].done = true; refresh(); } }
    function toggleEdit(i) { matches[i].done = false; refresh(); }
    function addMatch() { if(matches.length < 5) { matches.push({done:false, dbCur:0, h:{name:'',sl:3,balls:0}, a:{name:'',sl:3,balls:0}, cur:{h:[],a:[]}}); refresh(); } }
    function resetAll() { if(confirm("WIPE ALL DATA?")) { matches=[]; localStorage.clear(); addMatch(); refresh(); } }
    
    function exportJPG() { 
        html2canvas(document.getElementById('capture-area'), {backgroundColor:'#1a1a1a', scale: 2}).then(c => { 
            const l=document.createElement('a'); l.download='MVP_9Ball_Results.jpg'; l.href=c.toDataURL('image/jpeg', 1.0); l.click(); 
        }); 
    }

    if(matches.length === 0) addMatch();
    refresh();
</script>
</body>
</html>